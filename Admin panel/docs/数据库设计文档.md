# 记账系统数据库设计文档（用户端·PostgreSQL 18）

本文件为用户端数据库结构权威版本，严格遵循 PostgreSQL 18 语法规范。涵盖：枚举、表结构与约束、表间关系、ER 图、字段说明、索引策略、功能映射、版本化变更日志、DAO 接口规范、查询性能与并发处理方案。

注意：所有时间列统一使用 UTC 存储的 timestamptz；主键统一采用 UUID，默认值使用 gen_random_uuid()，需启用 pgcrypto 扩展。

## 0. 初始化与枚举类型

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 枚举
CREATE TYPE room_role AS ENUM ('room_leader','member');
CREATE TYPE bill_status AS ENUM ('draft','open','settling','settled','canceled');
CREATE TYPE split_type AS ENUM ('equal','custom','percentage');
CREATE TYPE payment_method AS ENUM ('cash','alipay','wechat','bank','credit','other');
CREATE TYPE payment_status AS ENUM ('pending','confirmed','canceled','failed');
CREATE TYPE transfer_status AS ENUM ('pending','confirmed','canceled');
CREATE TYPE qr_type AS ENUM ('wechat','alipay');
CREATE TYPE notification_type AS ENUM ('bill_due','payment_status','expense_added','system');
CREATE TYPE dispute_status AS ENUM ('pending','processing','resolved','escalated');
CREATE TYPE dispute_type AS ENUM ('payment','expense','room','other');
CREATE TYPE priority_level AS ENUM ('low','medium','high');
CREATE TYPE review_status AS ENUM ('pending','approved','rejected');
```

## 1. 用户与账户设置

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(64) NOT NULL UNIQUE,
  email VARCHAR(255) UNIQUE,
  display_name VARCHAR(128),
  avatar_url TEXT,
  password_hash TEXT,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE user_settings (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  locale VARCHAR(16) DEFAULT 'zh-CN',
  timezone VARCHAR(64) DEFAULT 'Asia/Shanghai',
  notifications_enabled BOOLEAN NOT NULL DEFAULT TRUE,
  notify_bill_due BOOLEAN NOT NULL DEFAULT TRUE,
  notify_payment_status BOOLEAN NOT NULL DEFAULT TRUE,
  notify_expense_added BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE user_third_party_accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  provider VARCHAR(64) NOT NULL,
  external_id VARCHAR(255) NOT NULL,
  UNIQUE (user_id, provider),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE user_activity_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  action VARCHAR(64) NOT NULL,
  detail JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## 2. 房间、成员与邀请码

```sql
CREATE TABLE rooms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  location VARCHAR(255),
  avatar_url TEXT,
  invite_code VARCHAR(32),
  created_by UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE room_members (
  room_id UUID NOT NULL REFERENCES rooms(id) ON UPDATE CASCADE ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  role room_role NOT NULL DEFAULT 'member',
  joined_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (room_id, user_id)
);

CREATE TABLE invite_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID NOT NULL REFERENCES rooms(id) ON UPDATE CASCADE ON DELETE CASCADE,
  code VARCHAR(16) NOT NULL UNIQUE,
  max_uses INT NOT NULL DEFAULT 1 CHECK (max_uses > 0),
  uses_count INT NOT NULL DEFAULT 0 CHECK (uses_count >= 0),
  expires_at TIMESTAMPTZ,
  revoked BOOLEAN NOT NULL DEFAULT FALSE,
  created_by UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## 3. 收款码（用户绑定微信/支付宝）

```sql
CREATE TABLE qr_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  qr_type qr_type NOT NULL,
  file_url TEXT NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  is_default BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (user_id, qr_type, is_default) DEFERRABLE INITIALLY DEFERRED
);
```

## 4. 账单、参与者、评论、结算与支付/转账

```sql
CREATE TABLE bills (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID NOT NULL REFERENCES rooms(id) ON UPDATE CASCADE ON DELETE CASCADE,
  title VARCHAR(100) NOT NULL,
  amount NUMERIC(12,2) NOT NULL CHECK (amount > 0),
  category VARCHAR(64) NOT NULL,
  due_date DATE NOT NULL,
  description TEXT,
  receipt_url TEXT,
  split_type split_type NOT NULL DEFAULT 'equal',
  status bill_status NOT NULL DEFAULT 'open',
  share_code VARCHAR(32) UNIQUE,
  share_expires_at TIMESTAMPTZ,
  created_by UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CHECK (char_length(title) >= 2)
);

CREATE TABLE bill_participants (
  bill_id UUID NOT NULL REFERENCES bills(id) ON UPDATE CASCADE ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  share_amount NUMERIC(12,2) NOT NULL CHECK (share_amount >= 0),
  percentage NUMERIC(5,2),
  paid_status payment_status NOT NULL DEFAULT 'pending',
  paid_at TIMESTAMPTZ,
  PRIMARY KEY (bill_id, user_id),
  CHECK ((percentage IS NULL) OR (percentage >= 0 AND percentage <= 100))
);

CREATE TABLE bill_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bill_id UUID NOT NULL REFERENCES bills(id) ON UPDATE CASCADE ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE bill_settlements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bill_id UUID NOT NULL UNIQUE REFERENCES bills(id) ON UPDATE CASCADE ON DELETE CASCADE,
  initiated_by UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  status payment_status NOT NULL DEFAULT 'pending',
  detail JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  confirmed_at TIMESTAMPTZ
);

CREATE TABLE payment_transfers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID REFERENCES rooms(id) ON UPDATE CASCADE ON DELETE SET NULL,
  bill_id UUID REFERENCES bills(id) ON UPDATE CASCADE ON DELETE SET NULL,
  from_user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  to_user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  amount NUMERIC(12,2) NOT NULL CHECK (amount > 0),
  status transfer_status NOT NULL DEFAULT 'pending',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  confirmed_at TIMESTAMPTZ,
  canceled_at TIMESTAMPTZ,
  CHECK (from_user_id <> to_user_id)
);

CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bill_id UUID NOT NULL REFERENCES bills(id) ON UPDATE CASCADE ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  method payment_method NOT NULL,
  amount NUMERIC(12,2) NOT NULL CHECK (amount > 0),
  status payment_status NOT NULL DEFAULT 'pending',
  qr_code_id UUID REFERENCES qr_codes(id) ON UPDATE CASCADE ON DELETE SET NULL,
  transaction_ref VARCHAR(128),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  confirmed_at TIMESTAMPTZ
);
```

## 5. 支出与分摊、凭证、类别

```sql
CREATE TABLE expense_categories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID REFERENCES rooms(id) ON UPDATE CASCADE ON DELETE CASCADE,
  name VARCHAR(64) NOT NULL,
  icon VARCHAR(64),
  created_by UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (room_id, name)
);

CREATE VIEW expense_types AS
  SELECT id, room_id, name AS type_name, icon FROM expense_categories;

CREATE TABLE expenses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID NOT NULL REFERENCES rooms(id) ON UPDATE CASCADE ON DELETE CASCADE,
  title VARCHAR(100) NOT NULL,
  amount NUMERIC(12,2) NOT NULL CHECK (amount > 0),
  category VARCHAR(64) NOT NULL,
  payment_method payment_method NOT NULL,
  payment_date DATE NOT NULL,
  split_type split_type NOT NULL DEFAULT 'equal',
  description TEXT,
  created_by UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE expense_splits (
  expense_id UUID NOT NULL REFERENCES expenses(id) ON UPDATE CASCADE ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  amount NUMERIC(12,2) NOT NULL CHECK (amount >= 0),
  percentage NUMERIC(5,2),
  PRIMARY KEY (expense_id, user_id),
  CHECK ((percentage IS NULL) OR (percentage >= 0 AND percentage <= 100))
);

CREATE TABLE expense_receipts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  expense_id UUID NOT NULL REFERENCES expenses(id) ON UPDATE CASCADE ON DELETE CASCADE,
  file_url TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## 6. 特殊支付规则

```sql
CREATE TABLE special_payment_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID NOT NULL REFERENCES rooms(id) ON UPDATE CASCADE ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  effective_from TIMESTAMPTZ,
  effective_to TIMESTAMPTZ,
  criteria JSONB NOT NULL,
  effect JSONB NOT NULL,
  created_by UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## 7. 通知系统

```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  type notification_type NOT NULL,
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  is_read BOOLEAN NOT NULL DEFAULT FALSE,
  action_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## 8. 争议处理与证据

```sql
CREATE TABLE disputes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID REFERENCES rooms(id) ON UPDATE CASCADE ON DELETE SET NULL,
  creator_id UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  handler_id UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  title VARCHAR(200) NOT NULL,
  description TEXT NOT NULL,
  type dispute_type NOT NULL,
  priority priority_level NOT NULL DEFAULT 'medium',
  status dispute_status NOT NULL DEFAULT 'pending',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE dispute_participants (
  dispute_id UUID NOT NULL REFERENCES disputes(id) ON UPDATE CASCADE ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  role VARCHAR(64) NOT NULL,
  status VARCHAR(32) NOT NULL DEFAULT 'pending',
  PRIMARY KEY (dispute_id, user_id)
);

CREATE TABLE dispute_evidence (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  dispute_id UUID NOT NULL REFERENCES disputes(id) ON UPDATE CASCADE ON DELETE CASCADE,
  evidence_type VARCHAR(32) NOT NULL CHECK (evidence_type IN ('image','document')),
  url TEXT NOT NULL,
  name VARCHAR(255),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE dispute_resolutions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  dispute_id UUID NOT NULL UNIQUE REFERENCES disputes(id) ON UPDATE CASCADE ON DELETE CASCADE,
  content TEXT NOT NULL,
  result VARCHAR(32) NOT NULL CHECK (result IN ('approved','rejected','compromise')),
  handler_id UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  resolved_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## 9. 评价与图片

```sql
CREATE TABLE reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID NOT NULL REFERENCES rooms(id) ON UPDATE CASCADE ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  rating SMALLINT NOT NULL CHECK (rating BETWEEN 1 AND 5),
  content TEXT,
  status review_status NOT NULL DEFAULT 'pending',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE review_images (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  review_id UUID NOT NULL REFERENCES reviews(id) ON UPDATE CASCADE ON DELETE CASCADE,
  image_url TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## 10. 表间关系与操作策略

- users ↔ rooms：N-M（通过 `room_members`）；rooms 1-N bills/expenses/reviews/disputes/invite_codes/special_payment_rules
- bills ↔ users：N-M（通过 `bill_participants`）；bills 1-N comments，1-1 settlements
- payments 关联 bills 与可选的 qr_codes；payment_transfers 关联 from_user/to_user（可选房间/账单）
- expenses ↔ users：N-M（通过 `expense_splits`）；expenses 1-N receipts
- disputes ↔ users：N-M（`dispute_participants`）；1-N evidence，1-1 resolutions
- 删除策略：删除 rooms 级联清理依赖；删除 bills 级联 participants/comments/settlements/payments；删除 users 对创建者字段多采用 SET NULL，参与关系采用 CASCADE

## 11. ER 图（dbdiagram DSL，可直接导入 dbdiagram.io）

```
// Users and settings
Table users {
  id uuid [pk]
  username varchar [unique, not null]
  email varchar [unique]
  display_name varchar
  avatar_url text
  is_active boolean
  created_at timestamptz
  updated_at timestamptz
}

Table user_settings {
  user_id uuid [pk, ref: > users.id]
  locale varchar
  timezone varchar
  notifications_enabled boolean
  notify_bill_due boolean
  notify_payment_status boolean
  notify_expense_added boolean
  created_at timestamptz
  updated_at timestamptz
}

Table rooms {
  id uuid [pk]
  name varchar [not null]
  description text
  location varchar
  avatar_url text
  invite_code varchar
  created_by uuid [ref: > users.id]
  created_at timestamptz
  updated_at timestamptz
}

Table room_members {
  room_id uuid [not null, ref: > rooms.id]
  user_id uuid [not null, ref: > users.id]
  role varchar
  joined_at timestamptz
  indexes { (room_id, user_id) [pk] }
}

Table invite_codes {
  id uuid [pk]
  room_id uuid [not null, ref: > rooms.id]
  code varchar [unique, not null]
  max_uses int
  uses_count int
  expires_at timestamptz
  revoked boolean
  created_by uuid [ref: > users.id]
  created_at timestamptz
}

Table bills {
  id uuid [pk]
  room_id uuid [not null, ref: > rooms.id]
  title varchar
  amount numeric
  category varchar
  due_date date
  description text
  receipt_url text
  split_type varchar
  status varchar
  share_code varchar [unique]
  share_expires_at timestamptz
  created_by uuid [ref: > users.id]
  created_at timestamptz
  updated_at timestamptz
}

Table bill_participants {
  bill_id uuid [not null, ref: > bills.id]
  user_id uuid [not null, ref: > users.id]
  share_amount numeric
  percentage numeric
  paid_status varchar
  paid_at timestamptz
  indexes { (bill_id, user_id) [pk] }
}

Table bill_comments {
  id uuid [pk]
  bill_id uuid [not null, ref: > bills.id]
  user_id uuid [not null, ref: > users.id]
  content text
  created_at timestamptz
}

Table bill_settlements {
  id uuid [pk]
  bill_id uuid [unique, not null, ref: > bills.id]
  initiated_by uuid [ref: > users.id]
  status varchar
  detail jsonb
  created_at timestamptz
  confirmed_at timestamptz
}

Table payment_transfers {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  bill_id uuid [ref: > bills.id]
  from_user_id uuid [ref: > users.id]
  to_user_id uuid [ref: > users.id]
  amount numeric
  status varchar
  created_at timestamptz
  confirmed_at timestamptz
  canceled_at timestamptz
}

Table qr_codes {
  id uuid [pk]
  user_id uuid [not null, ref: > users.id]
  qr_type varchar
  file_url text
  is_active boolean
  is_default boolean
  created_at timestamptz
  updated_at timestamptz
}

Table payments {
  id uuid [pk]
  bill_id uuid [not null, ref: > bills.id]
  user_id uuid [not null, ref: > users.id]
  method varchar
  amount numeric
  status varchar
  qr_code_id uuid [ref: > qr_codes.id]
  transaction_ref varchar
  created_at timestamptz
  confirmed_at timestamptz
}

Table expense_categories {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  name varchar
  icon varchar
  created_by uuid [ref: > users.id]
  created_at timestamptz
}

Table expenses {
  id uuid [pk]
  room_id uuid [not null, ref: > rooms.id]
  title varchar
  amount numeric
  category varchar
  payment_method varchar
  payment_date date
  split_type varchar
  description text
  created_by uuid [ref: > users.id]
  created_at timestamptz
  updated_at timestamptz
}

Table expense_splits {
  expense_id uuid [not null, ref: > expenses.id]
  user_id uuid [not null, ref: > users.id]
  amount numeric
  percentage numeric
  indexes { (expense_id, user_id) [pk] }
}

Table expense_receipts {
  id uuid [pk]
  expense_id uuid [not null, ref: > expenses.id]
  file_url text
  created_at timestamptz
}

Table special_payment_rules {
  id uuid [pk]
  room_id uuid [not null, ref: > rooms.id]
  name varchar
  is_active boolean
  effective_from timestamptz
  effective_to timestamptz
  criteria jsonb
  effect jsonb
  created_by uuid [ref: > users.id]
  created_at timestamptz
  updated_at timestamptz
}

Table notifications {
  id uuid [pk]
  user_id uuid [not null, ref: > users.id]
  type varchar
  title varchar
  content text
  is_read boolean
  action_url text
  created_at timestamptz
}

Table disputes {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  creator_id uuid [ref: > users.id]
  handler_id uuid [ref: > users.id]
  title varchar
  description text
  type varchar
  priority varchar
  status varchar
  created_at timestamptz
  updated_at timestamptz
}

Table dispute_participants {
  dispute_id uuid [not null, ref: > disputes.id]
  user_id uuid [not null, ref: > users.id]
  role varchar
  status varchar
  indexes { (dispute_id, user_id) [pk] }
}

Table dispute_evidence {
  id uuid [pk]
  dispute_id uuid [not null, ref: > disputes.id]
  evidence_type varchar
  url text
  name varchar
  created_at timestamptz
}

Table dispute_resolutions {
  id uuid [pk]
  dispute_id uuid [unique, not null, ref: > disputes.id]
  content text
  result varchar
  handler_id uuid [ref: > users.id]
  resolved_at timestamptz
}

Table reviews {
  id uuid [pk]
  room_id uuid [not null, ref: > rooms.id]
  user_id uuid [not null, ref: > users.id]
  rating int
  content text
  status varchar
  created_at timestamptz
  updated_at timestamptz
}

Table review_images {
  id uuid [pk]
  review_id uuid [not null, ref: > reviews.id]
  image_url text
  created_at timestamptz
}
```

## 12. 字段说明与示例（核心字段）

- bills
  - title：账单标题，如“10月水电费”
  - amount：金额，例如 3580.50
  - category：类别，如 utilities/internet/rent
  - due_date：到期日 YYYY-MM-DD
  - split_type：equal/custom/percentage
  - status：draft/open/settling/settled/canceled
  - share_code：例如“AB12CD34”，可配合 share_expires_at
- bill_participants
  - share_amount：成员应分摊金额；percentage：0–100，用于百分比分摊
  - paid_status：pending/confirmed/canceled/failed；paid_at：确认时间
- expenses
  - payment_method：cash/alipay/wechat/bank/credit/other
- notifications
  - type：bill_due/payment_status/expense_added/system
  - action_url：点击跳转链接
- disputes
  - type：payment/expense/room/other；priority：low/medium/high；status：pending/processing/resolved/escalated

## 13. 索引策略与示例

- 高频过滤与连接字段建立普通或复合索引：
  - room_members(room_id), room_members(user_id)
  - bills(room_id, status), bills(due_date), bills(share_code)
  - bill_participants(bill_id), bill_participants(user_id, paid_status)
  - payment_transfers(from_user_id, status), payment_transfers(to_user_id, status)
  - payments(bill_id, status), payments(user_id, status)
  - expenses(room_id, payment_date), expenses(category)
  - expense_splits(expense_id), expense_splits(user_id)
  - notifications(user_id, is_read, created_at DESC)
  - disputes(room_id, status, priority), disputes(creator_id)
  - reviews(room_id, status), reviews(user_id)

```sql
CREATE INDEX idx_bills_room_status ON bills(room_id, status);
CREATE INDEX idx_bills_due_date ON bills(due_date);
CREATE INDEX idx_bill_participants_user_paid ON bill_participants(user_id, paid_status);
CREATE INDEX idx_notifications_user_read_created ON notifications(user_id, is_read, created_at DESC);
CREATE INDEX idx_expenses_room_payment_date ON expenses(room_id, payment_date);
CREATE INDEX idx_disputes_room_status ON disputes(room_id, status);
CREATE INDEX idx_reviews_room_status ON reviews(room_id, status);
-- 部分索引（未读通知）
CREATE INDEX idx_notifications_user_unread ON notifications(user_id, created_at DESC) WHERE is_read = FALSE;
```

## 14. 功能映射矩阵（表字段 ↔ 页面功能）

- 账单 BillForm.vue：bills、bill_participants、bill_comments、bill_settlements、payments；分享使用 bills.share_code/share_expires_at
- 支付与二维码：qr_codes 绑定用户收款码；payments 记录支付确认；payment_transfers 记录成员间转账
- 支出 ExpenseCreate.vue：expenses、expense_splits、expense_receipts、expense_categories
- 房间/成员/邀请：rooms、room_members、invite_codes
- 通知中心：notifications（未读标记、列表、删除）
- 争议：disputes、dispute_participants、dispute_evidence、dispute_resolutions
- 评价：reviews、review_images
- 用户与设置：users、user_settings、user_third_party_accounts、user_activity_logs

## 15. 并发与事务处理

- 乐观锁（可选）：为 bills、expenses、disputes 增加 version INT，更新携带期望版本
- 防重与幂等：
  - payments 对 (bill_id, user_id, method, transaction_ref) 建唯一索引（如采用三方流水）
  - payment_transfers 依据业务需求建立去重唯一键
- 结算流程：事务中对 bills、bill_settlements 使用 SELECT ... FOR UPDATE；状态机 open→settling→settled
- DEFERRABLE 约束：qr_codes(user_id, qr_type, is_default) 使用延迟校验，事务尾验证

## 16. DAO 层接口规范（建议）

- BillRepository：createBill、updateBill、findById、listByRoom、addComment
- BillSettlementService：initiateSettlement、confirmSettlement
- PaymentService：createPayment、confirmPayment
- ExpenseRepository：createExpense(含 splits/receipts)、updateExpense、list
- DisputeService：createDispute、addParticipant、addEvidence、resolve
- NotificationService：listUnread、markRead、create

## 17. 查询性能优化

- 列表使用覆盖索引与 keyset pagination(created_at,id)
- 报表使用物化视图/汇总表，定时刷新
- JSONB 检索对关键路径加 GIN(jsonb_path_ops)
- 批量导出使用 COPY，合理设置 work_mem；连接池配置与预编译语句

## 18. 版本化变更日志

- v1.0.0：初始版本，包含 users/rooms/room_members/invite_codes/qr_codes/bills/bill_participants/bill_comments/bill_settlements/payments/payment_transfers/expense_categories/expenses/expense_splits/expense_receipts/special_payment_rules/notifications/disputes(+participants/evidence/resolutions)/reviews(+images)/user_settings/user_third_party_accounts/user_activity_logs 及全部枚举。
- v1.1.0：bills 增 share_code/share_expires_at；notifications 增未读部分索引；可选为 transfers 增业务唯一键。
- v1.2.0：special_payment_rules 扩展 criteria/effect 字段使用说明与索引。 

（本文件覆盖并替换旧版用户端相关设计；如需查看历史，请参考版本化变更日志与 Git 历史。）

---

# 管理端数据库设计（Admin Panel · PostgreSQL 18）

本章节在“用户端”结构基础上补充管理端专用数据模型，严格遵循：
- 不修改用户端既有表结构
- 新增表具备规范命名、精确类型、完整约束
- 明确与用户端的外键关联及联级策略

说明：以下每个表均标注业务用途。

## A. 权限与账号（RBAC）

用途：管理端基于角色的权限控制，支持精细到接口/菜单/页面动作。

```sql
CREATE TYPE admin_user_status AS ENUM ('active','disabled');
CREATE TYPE permission_type AS ENUM ('menu','page','api','action');

-- 管理端账号（可与 users 复用，也可独立；此处独立，避免影响用户端）
CREATE TABLE admin_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(64) NOT NULL UNIQUE,
  email VARCHAR(255) UNIQUE,
  display_name VARCHAR(128),
  password_hash TEXT NOT NULL,
  status admin_user_status NOT NULL DEFAULT 'active',
  last_login_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 角色
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(64) NOT NULL UNIQUE,
  description TEXT,
  is_system BOOLEAN NOT NULL DEFAULT FALSE, -- 系统内置角色
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 权限点
CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(128) NOT NULL UNIQUE, -- 如 admin.users.read
  name VARCHAR(128) NOT NULL,
  type permission_type NOT NULL,
  resource VARCHAR(256), -- 绑定的资源：路由/API 等
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 角色-权限（多对多）
CREATE TABLE role_permissions (
  role_id UUID NOT NULL REFERENCES roles(id) ON UPDATE CASCADE ON DELETE CASCADE,
  permission_id UUID NOT NULL REFERENCES permissions(id) ON UPDATE CASCADE ON DELETE CASCADE,
  granted_by UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  granted_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (role_id, permission_id)
);

-- 管理员-角色（多对多）
CREATE TABLE admin_user_roles (
  admin_user_id UUID NOT NULL REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE CASCADE,
  role_id UUID NOT NULL REFERENCES roles(id) ON UPDATE CASCADE ON DELETE CASCADE,
  assigned_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (admin_user_id, role_id)
);
```

索引与用途说明：
- 查询权限：permissions.code 唯一；role_permissions(role_id)；admin_user_roles(admin_user_id)
- 用于菜单控制、接口鉴权、操作授权审计

## B. 审计与操作日志（Admin）

用途：记录管理端关键操作、风控审计、数据追踪。

```sql
CREATE TYPE admin_operation AS ENUM ('create','update','delete','grant','revoke','export','import','login','logout','maintenance','other');

CREATE TABLE admin_operation_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_user_id UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  operation admin_operation NOT NULL,
  target_table VARCHAR(128),
  target_id UUID,
  payload JSONB, -- 变更前/后快照
  ip INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 数据变更审计（细粒度）
CREATE TABLE data_change_audits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_user_id UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  table_name VARCHAR(128) NOT NULL,
  record_id UUID NOT NULL,
  action admin_operation NOT NULL,
  before_values JSONB,
  after_values JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (table_name, record_id, id)
);
```

索引建议：
- admin_operation_logs(admin_user_id, created_at DESC)、(operation, created_at DESC)
- data_change_audits(table_name, record_id, created_at DESC)

## C. 批量任务与导出/导入、报表

用途：覆盖管理端常见的批量处理、数据导出、计划报表与快照。

```sql
CREATE TYPE job_status AS ENUM ('queued','running','succeeded','failed','canceled');
CREATE TYPE report_status AS ENUM ('draft','published','archived');

-- 批量任务
CREATE TABLE batch_jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_type VARCHAR(64) NOT NULL, -- 如 export_users, recompute_stats
  params JSONB,
  status job_status NOT NULL DEFAULT 'queued',
  queued_by UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  started_at TIMESTAMPTZ,
  finished_at TIMESTAMPTZ,
  result_summary JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 任务子项/运行日志
CREATE TABLE batch_job_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id UUID NOT NULL REFERENCES batch_jobs(id) ON UPDATE CASCADE ON DELETE CASCADE,
  shard_no INT,
  status job_status NOT NULL,
  log TEXT,
  started_at TIMESTAMPTZ,
  finished_at TIMESTAMPTZ
);

-- 报表定义
CREATE TABLE report_definitions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code VARCHAR(64) NOT NULL UNIQUE, -- 如 rpt_room_monthly_cost
  name VARCHAR(128) NOT NULL,
  description TEXT,
  query TEXT NOT NULL, -- SQL 模板（谨慎：仅管理员可维护）
  schedule_cron VARCHAR(64),
  status report_status NOT NULL DEFAULT 'published',
  created_by UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 报表快照
CREATE TABLE report_snapshots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  report_id UUID NOT NULL REFERENCES report_definitions(id) ON UPDATE CASCADE ON DELETE CASCADE,
  period_label VARCHAR(64), -- 如 2025-10, 2025-W44
  params JSONB,
  generated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  storage_url TEXT, -- 导出文件地址
  row_count INT,
  checksum VARCHAR(64)
);

-- 导出任务
CREATE TABLE data_exports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  export_type VARCHAR(64) NOT NULL, -- users, bills, expenses
  params JSONB,
  status job_status NOT NULL DEFAULT 'queued',
  file_url TEXT,
  requested_by UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  completed_at TIMESTAMPTZ
);
```

索引建议：
- batch_jobs(job_type, status, created_at DESC)
- report_snapshots(report_id, generated_at DESC)
- data_exports(export_type, status, created_at DESC)

## D. 内容审核与工单（Moderation & Tickets）

用途：对用户端可疑内容进行审核，处理用户反馈/工单。

```sql
CREATE TYPE review_outcome AS ENUM ('approved','rejected','escalated');
CREATE TYPE ticket_status AS ENUM ('open','processing','resolved','closed');

-- 审核队列（针对用户端对象：expense、bill、review 等）
CREATE TABLE moderation_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  entity_table VARCHAR(64) NOT NULL, -- bills/expenses/reviews/notifications
  entity_id UUID NOT NULL,
  reason VARCHAR(256),
  status review_status NOT NULL DEFAULT 'pending',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (entity_table, entity_id)
);

-- 审核记录
CREATE TABLE moderation_actions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  queue_id UUID NOT NULL REFERENCES moderation_queue(id) ON UPDATE CASCADE ON DELETE CASCADE,
  admin_user_id UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  decision review_outcome NOT NULL,
  comment TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 工单（来自用户端反馈或系统告警）
CREATE TABLE tickets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  status ticket_status NOT NULL DEFAULT 'open',
  created_by UUID REFERENCES users(id) ON UPDATE CASCADE ON DELETE SET NULL, -- 普通用户
  assigned_admin_id UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 工单备注
CREATE TABLE ticket_comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ticket_id UUID NOT NULL REFERENCES tickets(id) ON UPDATE CASCADE ON DELETE CASCADE,
  admin_user_id UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

索引建议：
- moderation_queue(status, created_at DESC)
- tickets(status, assigned_admin_id, updated_at DESC)

## E. 系统配置、开关与维护窗口

用途：平台级配置与灰度开关、维护期公告。

```sql
CREATE TABLE feature_flags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  flag_key VARCHAR(64) NOT NULL UNIQUE, -- 如 ff_new_report
  description TEXT,
  is_enabled BOOLEAN NOT NULL DEFAULT FALSE,
  conditions JSONB, -- 灰度条件，如 user segments
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE maintenance_windows (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(128) NOT NULL,
  message TEXT,
  starts_at TIMESTAMPTZ NOT NULL,
  ends_at TIMESTAMPTZ NOT NULL,
  is_global BOOLEAN NOT NULL DEFAULT TRUE,
  created_by UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  CHECK (ends_at > starts_at)
);

-- 管理端公告
CREATE TABLE admin_announcements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  visible_from TIMESTAMPTZ,
  visible_to TIMESTAMPTZ,
  created_by UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## F. 集成与回调（Webhooks）

用途：对接第三方平台（如导出到对象存储、消息系统）。

```sql
CREATE TYPE webhook_status AS ENUM ('active','disabled');

CREATE TABLE webhooks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) NOT NULL,
  target_url TEXT NOT NULL,
  secret VARCHAR(128),
  status webhook_status NOT NULL DEFAULT 'active',
  created_by UUID REFERENCES admin_users(id) ON UPDATE CASCADE ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE webhook_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  webhook_id UUID NOT NULL REFERENCES webhooks(id) ON UPDATE CASCADE ON DELETE CASCADE,
  event_code VARCHAR(64) NOT NULL, -- 如 bill.settled
  payload JSONB NOT NULL,
  delivered_at TIMESTAMPTZ,
  retry_count INT NOT NULL DEFAULT 0,
  last_error TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

## G. ER 图（含新增管理端表，标注 [ADMIN]）

可直接导入 dbdiagram.io：

```
// [ADMIN] 标记的为管理端新增
Table admin_users { id uuid [pk] username varchar [unique, not null] email varchar display_name varchar status varchar created_at timestamptz updated_at timestamptz }
Table roles { id uuid [pk] name varchar [unique, not null] is_system boolean created_at timestamptz updated_at timestamptz }
Table permissions { id uuid [pk] code varchar [unique, not null] name varchar type varchar created_at timestamptz }
Table role_permissions { role_id uuid [ref: > roles.id] permission_id uuid [ref: > permissions.id] indexes { (role_id, permission_id) [pk] } }
Table admin_user_roles { admin_user_id uuid [ref: > admin_users.id] role_id uuid [ref: > roles.id] indexes { (admin_user_id, role_id) [pk] } }

Table admin_operation_logs { id uuid [pk] admin_user_id uuid [ref: > admin_users.id] operation varchar created_at timestamptz }
Table data_change_audits { id uuid [pk] admin_user_id uuid [ref: > admin_users.id] table_name varchar record_id uuid action varchar created_at timestamptz }

Table batch_jobs { id uuid [pk] job_type varchar status varchar queued_by uuid [ref: > admin_users.id] created_at timestamptz }
Table batch_job_runs { id uuid [pk] job_id uuid [ref: > batch_jobs.id] status varchar started_at timestamptz }
Table report_definitions { id uuid [pk] code varchar [unique] name varchar status varchar created_by uuid [ref: > admin_users.id] }
Table report_snapshots { id uuid [pk] report_id uuid [ref: > report_definitions.id] generated_at timestamptz }
Table data_exports { id uuid [pk] export_type varchar status varchar requested_by uuid [ref: > admin_users.id] created_at timestamptz }

Table moderation_queue { id uuid [pk] entity_table varchar entity_id uuid status varchar created_at timestamptz }
Table moderation_actions { id uuid [pk] queue_id uuid [ref: > moderation_queue.id] admin_user_id uuid [ref: > admin_users.id] decision varchar created_at timestamptz }
Table tickets { id uuid [pk] title varchar status varchar created_by uuid [ref: > users.id] assigned_admin_id uuid [ref: > admin_users.id] updated_at timestamptz }
Table ticket_comments { id uuid [pk] ticket_id uuid [ref: > tickets.id] admin_user_id uuid [ref: > admin_users.id] created_at timestamptz }

Table feature_flags { id uuid [pk] flag_key varchar [unique] is_enabled boolean updated_at timestamptz }
Table maintenance_windows { id uuid [pk] title varchar starts_at timestamptz ends_at timestamptz created_by uuid [ref: > admin_users.id] }
Table admin_announcements { id uuid [pk] title varchar visible_from timestamptz created_by uuid [ref: > admin_users.id] }

Table webhooks { id uuid [pk] name varchar target_url text status varchar created_by uuid [ref: > admin_users.id] }
Table webhook_events { id uuid [pk] webhook_id uuid [ref: > webhooks.id] event_code varchar created_at timestamptz }
```

## H. 字段说明与示例（新增管理端表节选）

- admin_users.username：管理员登录名，例如 `ops_alice`
- permissions.code：权限编码，例如 `admin.reports.read`
- batch_jobs.job_type：如 `export_bills`
- report_definitions.code：如 `rpt_room_monthly_cost`
- moderation_queue.entity_table/entity_id：如 `bills` + 某账单 UUID
- tickets.status：`open/processing/resolved/closed`

## I. 索引策略与优化

- RBAC：role_permissions(role_id, permission_id) PK；admin_user_roles(admin_user_id, role_id) PK；permissions(code) UNIQUE
- 审计：admin_operation_logs(admin_user_id, created_at DESC)；data_change_audits(table_name, record_id, created_at DESC)
- 批量/报表：batch_jobs(job_type, status, created_at DESC)；report_snapshots(report_id, generated_at DESC)
- 工单：tickets(status, assigned_admin_id, updated_at DESC)
- Webhook：webhook_events(webhook_id, created_at DESC)

## J. 功能映射（用户端 vs 管理端）

- 用户端：参见上文第14节
- 管理端：
  - 账号与权限：admin_users、roles、permissions、role_permissions、admin_user_roles
  - 操作审计：admin_operation_logs、data_change_audits
  - 批量与报表：batch_jobs、batch_job_runs、report_definitions、report_snapshots、data_exports
  - 内容审核与工单：moderation_queue、moderation_actions、tickets、ticket_comments
  - 配置与维护：feature_flags、maintenance_windows、admin_announcements
  - 集成与回调：webhooks、webhook_events

## K. 并发控制与事务设计

- RBAC 变更：为防权限抖动，授予/回收使用事务；必要时锁定受影响管理员会话（应用层）
- 批量任务：创建 job + 多 run 采用事务；运行状态通过 UPDATE ... WHERE status 防止并发覆盖
- 审核/工单：处理同一 queue/ticket 使用 `SELECT ... FOR UPDATE` 保证串行化
- 导出：避免重复提交，可对 (export_type, requested_by, created_at::date) 建部分唯一索引（按需）

## L. 典型查询示例

```sql
-- 查询某管理员的菜单/权限
SELECT p.code, p.type
FROM admin_users au
JOIN admin_user_roles aur ON aur.admin_user_id = au.id
JOIN role_permissions rp ON rp.role_id = aur.role_id
JOIN permissions p ON p.id = rp.permission_id
WHERE au.username = $1;

-- 最近的房间月度费用报表快照
SELECT rs.*
FROM report_definitions rd
JOIN report_snapshots rs ON rs.report_id = rd.id
WHERE rd.code = 'rpt_room_monthly_cost'
ORDER BY rs.generated_at DESC
LIMIT 1;

-- 审核队列待处理项
SELECT * FROM moderation_queue
WHERE status = 'pending'
ORDER BY created_at ASC
LIMIT 50;

-- 工单看板：按状态与指派人分组统计
SELECT status, assigned_admin_id, COUNT(*)
FROM tickets
GROUP BY status, assigned_admin_id;
```

## M. 版本化变更日志（管理端）

- v2.0.0：新增管理端数据模型（RBAC、审计日志、批量与报表、审核与工单、配置/维护、Webhook），不修改用户端表结构。
