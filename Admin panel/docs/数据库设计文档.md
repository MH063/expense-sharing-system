# 统一数据库设计文档

## 1. 设计概述

本文档描述了记账系统的统一数据库设计，整合了前端和管理端的数据库表结构，遵循共享数据库模式设计原则，确保数据一致性、可扩展性和性能优化。

### 1.1 设计原则

1. **统一性**：前端和管理端共享同一数据库，避免数据冗余和不一致
2. **规范化**：遵循数据库规范化原则，减少数据冗余
3. **可扩展性**：设计支持未来功能扩展
4. **性能优化**：合理设计索引和查询结构
5. **安全性**：实现细粒度权限控制
6. **审计追踪**：记录关键数据变更历史

### 1.2 核心模块

1. **用户认证与权限管理**：统一用户认证系统，支持RBAC权限模型
2. **房间管理**：支持多人协作的房间系统
3. **账单管理**：账单创建、分摊和结算
4. **费用管理**：费用记录、审核和统计
5. **支付管理**：支付记录和二维码管理
6. **争议管理**：争议处理和解决
7. **系统管理**：系统配置、日志和审计

## 2. 数据库架构

### 2.1 表结构分类

#### 2.1.1 用户认证与权限管理
- `users` - 用户基础信息
- `user_profiles` - 用户配置文件
- `user_settings` - 用户设置
- `admins` - 管理员信息
- `roles` - 角色定义
- `permissions` - 权限定义
- `role_permissions` - 角色权限关联
- `user_roles` - 用户角色关联
- `admin_roles` - 管理员角色关联
- `user_tokens` - 用户令牌
- `admin_tokens` - 管理员令牌
- `third_party_accounts` - 第三方账户关联

#### 2.1.2 房间管理
- `rooms` - 房间信息
- `room_members` - 房间成员
- `room_invitations` - 房间邀请
- `room_leaders` - 房间负责人
- `room_expense_settings` - 房间费用设置

#### 2.1.3 账单管理
- `bill_categories` - 账单类别
- `bills` - 账单信息
- `bill_comments` - 账单评论
- `bill_splits` - 账单分摊
- `bill_settlement_status` - 账单结算状态
- `bill_statistics` - 账单统计

#### 2.1.4 费用管理
- `expense_categories` - 费用类别
- `expenses` - 费用信息
- `expense_splits` - 费用分摊
- `expense_receipts` - 费用凭证
- `expense_approval_status` - 费用审核状态
- `expense_limits` - 费用限制
- `historical_expense_stats` - 历史费用统计
- `historical_reading_stats` - 历史读数统计
- `expense_dispute_status` - 费用争议状态
- `expense_statistics` - 费用统计
- `expense_tags` - 费用标签
- `expense_tag_relations` - 费用标签关联

#### 2.1.5 支付管理
- `payments` - 支付记录
- `payment_transfers` - 支付转账
- `qr_codes` - 二维码管理
- `qr_payment_records` - 支付码扫描记录
- `user_payment_preferences` - 用户支付偏好

#### 2.1.6 争议管理
- `disputes` - 争议信息
- `dispute_participants` - 争议参与者
- `dispute_evidence` - 争议证据
- `dispute_assignments` - 争议分配
- `dispute_handling_logs` - 争议处理日志

#### 2.1.7 评论管理
- `reviews` - 评论信息
- `review_images` - 评论图片

#### 2.1.8 邀请码管理
- `invite_codes` - 邀请码
- `invite_code_usage` - 邀请码使用记录

#### 2.1.9 活动管理
- `activities` - 活动信息
- `activity_participants` - 活动参与者

#### 2.1.10 特殊支付规则
- `expense_types` - 费用类型
- `special_payment_rules` - 特殊支付规则
- `room_payment_rules` - 房间支付规则

#### 2.1.11 系统管理
- `system_configs` - 系统配置
- `feature_flags` - 功能开关
- `maintenance_windows` - 维护窗口
- `announcements` - 公告

#### 2.1.12 日志和审计
- `user_activity_logs` - 用户活动日志
- `user_status_logs` - 用户状态变更日志
- `admin_operation_logs` - 管理员操作日志
- `data_change_audits` - 数据变更审计
- `system_error_logs` - 系统错误日志
- `system_audit_logs` - 系统审计日志

#### 2.1.13 通知管理
- `notifications` - 通知
- `bill_payment_reminders` - 账单支付提醒

#### 2.1.14 批量任务与报表
- `batch_jobs` - 批量任务
- `report_definitions` - 报表定义
- `report_snapshots` - 报表快照
- `export_tasks` - 导出任务

#### 2.1.15 内容审核与工单
- `moderation_queue` - 审核队列
- `support_tickets` - 支持工单
- `ticket_comments` - 工单评论

#### 2.1.16 集成与回调
- `webhooks` - Webhooks
- `webhook_events` - Webhook事件

#### 2.1.17 文档管理
- `documents` - 文档
- `document_histories` - 文档历史
- `document_types` - 文档类型
- `document_statistics` - 文档统计
- `document_access_logs` - 文档访问日志

#### 2.1.18 系统维护
- `data_backup_records` - 数据备份记录
- `data_restore_records` - 数据恢复记录
- `system_maintenance_plans` - 系统维护计划
- `system_maintenance_executions` - 系统维护执行记录

#### 2.1.19 其他辅助表
- `password_reset_tokens` - 密码重置令牌
- `user_activity_statistics` - 用户活动统计
- `expense_split_history` - 费用分摊历史
- `expense_lines` - 费用线路
- `expense_reviews` - 费用审核
- `abnormal_expenses` - 异常费用
- `abnormal_expense_stats` - 异常费用统计
- `admin_sessions` - 管理员会话
- `admin_permission_history` - 管理员权限变更历史
- `admin_operation_restrictions` - 管理员操作限制
- `admin_operation_statistics` - 管理员操作统计
- `system_performance_metrics` - 系统性能监控
- `system_resource_usage` - 系统资源使用

### 2.2 关键表关系

#### 2.2.1 用户认证与权限管理关系

```
users (1) -> (n) user_profiles
users (1) -> (n) user_settings
users (1) -> (n) user_tokens
users (1) -> (n) user_roles
users (1) -> (n) third_party_accounts

admins (1) -> (1) users
admins (1) -> (n) admin_tokens
admins (1) -> (n) admin_roles

roles (1) -> (n) role_permissions
roles (1) -> (n) user_roles
roles (1) -> (n) admin_roles

permissions (1) -> (n) role_permissions
```

#### 2.2.2 房间管理关系

```
users (1) -> (n) rooms (creator)
users (1) -> (n) room_members
users (1) -> (n) room_invitations (inviter)
users (1) -> (n) room_leaders

rooms (1) -> (n) room_members
rooms (1) -> (n) room_invitations
rooms (1) -> (n) room_leaders
rooms (1) -> (1) room_expense_settings
```

#### 2.2.3 账单管理关系

```
users (1) -> (n) bills (creator)
users (1) -> (n) bill_comments
users (1) -> (n) bill_splits

rooms (1) -> (n) bills
bill_categories (1) -> (n) bills

bills (1) -> (n) bill_comments
bills (1) -> (n) bill_splits
bills (1) -> (1) bill_settlement_status
bills (1) -> (n) bill_statistics
```

#### 2.2.4 费用管理关系

```
users (1) -> (n) expenses (payer)
users (1) -> (n) expense_splits

rooms (1) -> (n) expenses
expense_categories (1) -> (n) expenses

expenses (1) -> (n) expense_splits
expenses (1) -> (n) expense_receipts
expenses (1) -> (1) expense_approval_status
expenses (1) -> (n) expense_lines
expenses (1) -> (1) expense_dispute_status
expenses (1) -> (n) expense_reviews
expenses (1) -> (1) abnormal_expenses
```

## 3. 设计特点

### 3.1 统一用户认证系统

通过将管理员表与用户表关联，实现了统一的用户认证系统。管理员账户基于用户账户创建，但拥有额外的管理权限和功能。

### 3.2 RBAC权限模型

采用基于角色的访问控制(RBAC)模型，通过角色和权限的灵活组合，实现细粒度的权限控制。支持用户角色和管理员角色分离。

### 3.3 版本控制

关键业务表(如bills、expenses等)添加了version字段，支持乐观锁和版本控制，确保并发操作的数据一致性。

### 3.4 审计追踪

通过data_change_audits表记录关键数据变更，支持审计追踪。管理员操作通过admin_operation_logs表记录，确保操作可追溯。

### 3.5 性能优化

1. 合理设计索引，提高查询性能
2. 使用JSONB字段存储灵活配置，减少表结构变更
3. 通过视图简化复杂查询
4. 统计表预计算常用统计数据

### 3.6 可扩展性

1. 模块化设计，便于功能扩展
2. 使用feature_flags控制功能开关
3. 系统配置表支持动态配置
4. 预留扩展字段和表

## 4. 数据一致性保障

### 4.1 外键约束

通过外键约束确保数据引用完整性，如：
- 用户删除时级联删除相关记录
- 房间删除时级联删除相关记录
- 账单删除时级联删除相关记录

### 4.2 事务处理

关键业务操作使用事务确保数据一致性，如：
- 账单创建和分摊记录
- 费用创建和分摊记录
- 支付确认和状态更新

### 4.3 数据校验

通过数据库约束和应用层校验确保数据有效性，如：
- 金额字段非负校验
- 日期字段范围校验
- 状态字段枚举值校验

## 5. 安全性考虑

### 5.1 密码安全

- 密码使用哈希存储
- 支持密码重置功能
- 密码复杂度要求

### 5.2 会话管理

- 使用令牌管理会话
- 令牌过期机制
- 设备管理

### 5.3 权限控制

- 基于角色的权限控制
- 细粒度权限定义
- 权限变更审计

### 5.4 数据保护

- 敏感数据加密
- 数据访问控制
- 操作日志记录

## 6. 部署和维护

### 6.1 数据库初始化

1. 执行统一数据库设计脚本创建表结构
2. 执行初始数据脚本插入基础数据
3. 创建必要的索引和约束
4. 配置数据库参数

### 6.2 数据备份

1. 定期全量备份
2. 增量备份策略
3. 备份验证机制
4. 灾难恢复计划

### 6.3 性能监控

1. 慢查询监控
2. 索引使用情况分析
3. 表空间监控
4. 连接数监控

### 6.4 数据维护

1. 定期数据清理
2. 统计数据更新
3. 索引优化
4. 表分析

## 7. 未来扩展计划

### 7.1 功能扩展

1. 多租户支持
2. 国际化支持
3. 高级报表功能
4. 机器学习集成

### 7.2 性能优化

1. 读写分离
2. 分库分表
3. 缓存策略
4. 查询优化

### 7.3 安全增强

1. 多因素认证
2. 数据脱敏
3. 访问控制增强
4. 安全审计增强

## 7. 其他辅助表

### 7.1 密码重置令牌表 (password_reset_tokens)
用于管理用户密码重置令牌，支持密码找回功能。

**字段说明：**
- id: 主键，自增
- user_id: 用户ID，关联users表
- token: 重置令牌，唯一标识
- expires_at: 过期时间
- used: 是否已使用
- created_at: 创建时间

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY (token)
- KEY (user_id)
- KEY (expires_at)

### 7.2 用户活动统计表 (user_activity_statistics)
用于统计用户活动数据，支持用户行为分析。

**字段说明：**
- id: 主键，自增
- user_id: 用户ID，关联users表
- stat_date: 统计日期
- login_count: 登录次数
- action_count: 操作次数
- created_at: 创建时间
- updated_at: 更新时间

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY (user_id, stat_date)
- KEY (stat_date)

### 7.3 费用分摊历史表 (expense_split_history)
用于记录费用分摊的历史变更，支持费用分摊审计。

**字段说明：**
- id: 主键，自增
- expense_split_id: 费用分摊ID，关联expense_splits表
- user_id: 用户ID，关联users表
- old_amount: 原金额
- new_amount: 新金额
- change_reason: 变更原因
- changed_by: 变更人ID，关联users表
- created_at: 创建时间

**索引：**
- PRIMARY KEY (id)
- KEY (expense_split_id)
- KEY (user_id)
- KEY (changed_by)
- KEY (created_at)

### 7.4 费用线路表 (expense_lines)
用于记录费用线路信息，支持多线路费用管理。

**字段说明：**
- id: 主键，自增
- expense_id: 费用ID，关联expenses表
- line_name: 线路名称
- line_type: 线路类型
- line_amount: 线路金额
- created_at: 创建时间

**索引：**
- PRIMARY KEY (id)
- KEY (expense_id)
- KEY (line_type)

### 7.5 费用审核表 (expense_reviews)
用于记录费用审核信息，支持费用审核流程。

**字段说明：**
- id: 主键，自增
- expense_id: 费用ID，关联expenses表
- reviewer_id: 审核人ID，关联users表
- status: 审核状态
- review_comment: 审核意见
- created_at: 创建时间

**索引：**
- PRIMARY KEY (id)
- KEY (expense_id)
- KEY (reviewer_id)
- KEY (status)

### 7.6 异常费用表 (abnormal_expenses)
用于记录异常费用信息，支持异常费用管理。

**字段说明：**
- id: 主键，自增
- expense_id: 费用ID，关联expenses表
- abnormal_type: 异常类型
- abnormal_reason: 异常原因
- status: 处理状态
- handled_by: 处理人ID，关联users表
- handled_at: 处理时间
- created_at: 创建时间

**索引：**
- PRIMARY KEY (id)
- KEY (expense_id)
- KEY (abnormal_type)
- KEY (status)
- KEY (handled_by)

### 7.7 异常费用统计表 (abnormal_expense_stats)
用于统计异常费用数据，支持异常费用分析。

**字段说明：**
- id: 主键，自增
- stat_date: 统计日期
- abnormal_count: 异常数量
- abnormal_amount: 异常金额
- handled_count: 已处理数量
- created_at: 创建时间

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY (stat_date)

## 8. 系统管理扩展表

### 8.1 管理员会话表 (admin_sessions)
用于管理管理员登录会话，支持管理员会话管理。

**字段说明：**
- id: 主键，自增
- admin_id: 管理员ID，关联admins表
- session_token: 会话令牌
- ip_address: IP地址
- user_agent: 用户代理
- expires_at: 过期时间
- created_at: 创建时间

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY (session_token)
- KEY (admin_id)
- KEY (expires_at)

### 8.2 管理员权限历史表 (admin_permission_history)
用于记录管理员权限变更历史，支持权限审计。

**字段说明：**
- id: 主键，自增
- admin_id: 管理员ID，关联admins表
- action: 操作类型
- permission_data: 权限数据
- operated_by: 操作人ID，关联admins表
- created_at: 创建时间

**索引：**
- PRIMARY KEY (id)
- KEY (admin_id)
- KEY (operated_by)
- KEY (created_at)

### 8.3 管理员操作限制表 (admin_operation_restrictions)
用于设置管理员操作限制，支持管理员权限控制。

**字段说明：**
- id: 主键，自增
- admin_id: 管理员ID，关联admins表
- restriction_type: 限制类型
- restriction_data: 限制数据
- created_at: 创建时间
- updated_at: 更新时间

**索引：**
- PRIMARY KEY (id)
- KEY (admin_id)
- KEY (restriction_type)

### 8.4 管理员操作统计表 (admin_operation_statistics)
用于统计管理员操作数据，支持管理员操作分析。

**字段说明：**
- id: 主键，自增
- admin_id: 管理员ID，关联admins表
- operation_type: 操作类型
- operation_count: 操作次数
- stat_date: 统计日期
- created_at: 创建时间

**索引：**
- PRIMARY KEY (id)
- KEY (admin_id)
- KEY (operation_type)
- KEY (stat_date)

### 8.5 系统性能指标表 (system_performance_metrics)
用于记录系统性能指标，支持系统性能监控。

**字段说明：**
- id: 主键，自增
- metric_name: 指标名称
- metric_value: 指标值
- metric_unit: 指标单位
- recorded_at: 记录时间

**索引：**
- PRIMARY KEY (id)
- KEY (metric_name)
- KEY (recorded_at)

### 8.6 系统资源使用表 (system_resource_usage)
用于记录系统资源使用情况，支持资源监控。

**字段说明：**
- id: 主键，自增
- cpu_usage: CPU使用率
- memory_usage: 内存使用率
- disk_usage: 磁盘使用率
- network_in: 网络入流量
- network_out: 网络出流量
- recorded_at: 记录时间

**索引：**
- PRIMARY KEY (id)
- KEY (recorded_at)

## 9. 数据库触发器

### 9.1 更新时间触发器
为所有包含`updated_at`字段的表创建自动更新触发器，确保在记录更新时自动设置当前时间。

**触发器函数：**
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';
```

**应用触发器的表：**
- users
- user_profiles
- user_settings
- admins
- roles
- rooms
- room_expense_settings
- bills
- bill_comments
- bill_settlement_status
- bill_statistics
- expenses
- expense_limits
- expense_statistics
- user_payment_preferences
- system_configs
- feature_flags
- maintenance_windows
- announcements
- document_statistics
- system_maintenance_plans
- admin_operation_restrictions

## 10. 数据库视图

### 10.1 用户详细信息视图 (user_details)
整合用户基本信息、档案和设置数据，提供完整的用户视图。

### 10.2 管理员详细信息视图 (admin_details)
整合管理员基本信息和关联用户信息，提供完整的管理员视图。

### 10.3 房间详细信息视图 (room_details)
整合房间基本信息、创建者信息和成员统计，提供完整的房间视图。

### 10.4 账单详细信息视图 (bill_details)
整合账单基本信息、分类、创建者、房间和分摊信息，提供完整的账单视图。

### 10.5 费用详细信息视图 (expense_details)
整合费用基本信息、分类、支付者、房间和分摊信息，提供完整的费用视图。

## 11. 数据库索引策略

### 11.1 主键索引
所有表都使用自增ID作为主键，自动创建聚簇索引。

### 11.2 唯一索引
- users表：username, email, uuid
- user_profiles表：user_id
- user_settings表：user_id
- admins表：user_id, username, email, uuid
- roles表：name, uuid
- rooms表：invite_code, uuid
- bills表：uuid
- expenses表：uuid
- 等等

### 11.3 外键索引
所有外键字段都创建索引，提高关联查询性能。

### 11.4 查询优化索引
根据常用查询场景创建复合索引，如：
- user_activity_statistics表：(user_id, stat_date)
- admin_sessions表：(admin_id, expires_at)
- system_performance_metrics表：(metric_name, recorded_at)
- 等等

## 12. 数据库性能优化

### 12.1 分区策略
对于大数据量表，可以考虑按时间分区：
- user_activity_logs表：按月分区
- admin_operation_logs表：按月分区
- bill_statistics表：按月分区
- expense_statistics表：按月分区

### 12.2 读写分离
对于高并发场景，可以考虑主从复制，实现读写分离。

### 12.3 缓存策略
对于热点数据，可以使用Redis等缓存系统：
- 用户会话信息
- 房间基本信息
- 系统配置信息
- 等等

## 13. 数据库安全

### 13.1 敏感数据加密
- 用户密码：使用bcrypt哈希
- 敏感个人信息：使用AES加密
- 支付信息：使用PCI DSS标准加密

### 13.2 访问控制
- 数据库用户权限最小化
- 应用层访问控制
- 审计日志记录

### 13.3 数据备份
- 定期全量备份
- 增量备份策略
- 异地备份存储

## 14. 数据库维护

### 14.1 定期维护任务
- 索引重建和优化
- 统计信息更新
- 日志清理
- 数据归档

### 14.2 监控告警
- 性能指标监控
- 错误日志监控
- 存储空间监控
- 连接数监控

## 15. 版本控制与变更管理

### 15.1 数据库版本控制
- 使用迁移脚本管理数据库变更
- 版本号管理
- 回滚策略

### 15.2 变更流程
- 变更申请
- 变更评审
- 变更实施
- 变更验证

## 8. 总结

本数据库设计涵盖了记账系统的所有核心功能模块，包括用户认证与权限管理、房间管理、账单管理、费用管理、支付管理、争议管理、评论管理、邀请码管理、活动管理、特殊支付规则、系统管理、日志和审计、通知管理、批量任务与报表、内容审核与工单、集成与回调、文档管理、系统维护以及其他辅助功能。

设计特点：
1. 统一的用户认证和权限管理系统
2. 完整的RBAC权限模型
3. 灵活的账单和费用管理
4. 多种支付方式支持
5. 完善的争议处理流程
6. 全面的日志和审计功能
7. 高效的索引和查询优化
8. 完善的数据安全和备份策略

该设计具有良好的扩展性和维护性，可以满足记账系统当前和未来的业务需求。