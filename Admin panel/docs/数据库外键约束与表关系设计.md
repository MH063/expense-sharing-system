# 数据库外键约束与表关系设计（用户端·PostgreSQL 18）

本文件系统化描述用户端数据库的外键策略、关系类型、一致性保障与联级操作设计，并提供可执行的核心表 SQL 片段与 ER 关系示意，严格遵循 PostgreSQL 18 语法规范。

## 1. 关系模型总览

- 用户与房间：N-M，通过 `room_members`；房间与账单/支出/通知/争议/评价/特殊规则：1-N
- 账单与用户：N-M，通过 `bill_participants`；账单与评论：1-N；账单与结算：1-1
- 支付：`payments` 关联账单和用户；`payment_transfers` 记录成员之间转账
- 支出：`expenses` 与用户 N-M（`expense_splits`），与凭证 1-N
- 争议：`disputes` 与用户 N-M（`dispute_participants`），与证据 1-N，与解决方案 1-1
- 收款码：`qr_codes` 归属用户，payments 可引用

## 2. 外键与级联策略清单

说明：以下仅列出核心关系。所有外键在 ON UPDATE 上统一采用 CASCADE；ON DELETE 根据业务重要性选择 CASCADE 或 SET NULL。

```sql
-- users ←→ user_settings（一对一，强依赖）
ALTER TABLE user_settings
  ADD CONSTRAINT fk_user_settings_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

-- rooms 归属与成员
ALTER TABLE rooms
  ADD CONSTRAINT fk_rooms_created_by
  FOREIGN KEY (created_by) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE room_members
  ADD CONSTRAINT fk_room_members_room
  FOREIGN KEY (room_id) REFERENCES rooms(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE room_members
  ADD CONSTRAINT fk_room_members_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

-- 邀请码
ALTER TABLE invite_codes
  ADD CONSTRAINT fk_invite_codes_room
  FOREIGN KEY (room_id) REFERENCES rooms(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE invite_codes
  ADD CONSTRAINT fk_invite_codes_creator
  FOREIGN KEY (created_by) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

-- 收款码
ALTER TABLE qr_codes
  ADD CONSTRAINT fk_qr_codes_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

-- 账单域
ALTER TABLE bills
  ADD CONSTRAINT fk_bills_room
  FOREIGN KEY (room_id) REFERENCES rooms(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE bills
  ADD CONSTRAINT fk_bills_creator
  FOREIGN KEY (created_by) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE bill_participants
  ADD CONSTRAINT fk_bill_participants_bill
  FOREIGN KEY (bill_id) REFERENCES bills(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE bill_participants
  ADD CONSTRAINT fk_bill_participants_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE bill_comments
  ADD CONSTRAINT fk_bill_comments_bill
  FOREIGN KEY (bill_id) REFERENCES bills(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE bill_comments
  ADD CONSTRAINT fk_bill_comments_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE bill_settlements
  ADD CONSTRAINT fk_bill_settlements_bill
  FOREIGN KEY (bill_id) REFERENCES bills(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE bill_settlements
  ADD CONSTRAINT fk_bill_settlements_user
  FOREIGN KEY (initiated_by) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

-- 支付与转账
ALTER TABLE payments
  ADD CONSTRAINT fk_payments_bill
  FOREIGN KEY (bill_id) REFERENCES bills(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE payments
  ADD CONSTRAINT fk_payments_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE payments
  ADD CONSTRAINT fk_payments_qr
  FOREIGN KEY (qr_code_id) REFERENCES qr_codes(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE payment_transfers
  ADD CONSTRAINT fk_transfers_room
  FOREIGN KEY (room_id) REFERENCES rooms(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE payment_transfers
  ADD CONSTRAINT fk_transfers_bill
  FOREIGN KEY (bill_id) REFERENCES bills(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE payment_transfers
  ADD CONSTRAINT fk_transfers_from
  FOREIGN KEY (from_user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE payment_transfers
  ADD CONSTRAINT fk_transfers_to
  FOREIGN KEY (to_user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

-- 支出与分摊、凭证
ALTER TABLE expense_categories
  ADD CONSTRAINT fk_expense_categories_room
  FOREIGN KEY (room_id) REFERENCES rooms(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE expense_categories
  ADD CONSTRAINT fk_expense_categories_creator
  FOREIGN KEY (created_by) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE expenses
  ADD CONSTRAINT fk_expenses_room
  FOREIGN KEY (room_id) REFERENCES rooms(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE expenses
  ADD CONSTRAINT fk_expenses_creator
  FOREIGN KEY (created_by) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE expense_splits
  ADD CONSTRAINT fk_expense_splits_expense
  FOREIGN KEY (expense_id) REFERENCES expenses(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE expense_splits
  ADD CONSTRAINT fk_expense_splits_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE expense_receipts
  ADD CONSTRAINT fk_expense_receipts_expense
  FOREIGN KEY (expense_id) REFERENCES expenses(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

-- 通知
ALTER TABLE notifications
  ADD CONSTRAINT fk_notifications_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

-- 争议域
ALTER TABLE disputes
  ADD CONSTRAINT fk_disputes_room
  FOREIGN KEY (room_id) REFERENCES rooms(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE disputes
  ADD CONSTRAINT fk_disputes_creator
  FOREIGN KEY (creator_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE disputes
  ADD CONSTRAINT fk_disputes_handler
  FOREIGN KEY (handler_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE dispute_participants
  ADD CONSTRAINT fk_dispute_participants_dispute
  FOREIGN KEY (dispute_id) REFERENCES disputes(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE dispute_participants
  ADD CONSTRAINT fk_dispute_participants_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE dispute_evidence
  ADD CONSTRAINT fk_dispute_evidence_dispute
  FOREIGN KEY (dispute_id) REFERENCES disputes(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE dispute_resolutions
  ADD CONSTRAINT fk_dispute_resolutions_dispute
  FOREIGN KEY (dispute_id) REFERENCES disputes(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

-- 评价
ALTER TABLE reviews
  ADD CONSTRAINT fk_reviews_room
  FOREIGN KEY (room_id) REFERENCES rooms(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE reviews
  ADD CONSTRAINT fk_reviews_user
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE review_images
  ADD CONSTRAINT fk_review_images_review
  FOREIGN KEY (review_id) REFERENCES reviews(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
```

## 3. 关系类型标注与说明

- 一对一：`user_settings.user_id ↔ users.id`，`bill_settlements.bill_id ↔ bills.id`，`dispute_resolutions.dispute_id ↔ disputes.id`
- 一对多：`rooms.id → bills/expenses/reviews/disputes/invite_codes`，`bills.id → bill_comments/payments`
- 多对多：`rooms ↔ users` 通过 `room_members`；`bills ↔ users` 通过 `bill_participants`；`expenses ↔ users` 通过 `expense_splits`

## 4. 典型约束与 CHECK 策略

- 金额与百分比：`amount > 0`，`percentage BETWEEN 0 AND 100`
- 身份与角色：`room_members.role IN ('room_leader','member')`
- 转账双方不同：`payment_transfers.from_user_id <> payment_transfers.to_user_id`
- 文本长度：`bills.title` 至少 2 个字符

## 5. 关联操作处理（删除/更新策略）

- 删除房间：级联删除房间下的一切强依赖数据（账单、参与者、支付、支出、分摊、通知、评价、争议、邀请码、成员关系、特殊支付规则）
- 删除账单：级联删除其参与者、评论、结算与支付记录；转账记录保留（外键可置空）
- 删除用户：创建者字段采用 SET NULL；成员关系、分摊、参与者等关系采用 CASCADE，保证不留孤儿记录

## 6. ER 关系图（dbdiagram DSL）

``` 
Table users {
  id uuid [pk]
  username varchar [unique, not null]
}
Table user_settings {
  user_id uuid [pk, ref: > users.id]
}
Table rooms {
  id uuid [pk]
  created_by uuid [ref: > users.id]
}
Table room_members {
  room_id uuid [ref: > rooms.id]
  user_id uuid [ref: > users.id]
  indexes { (room_id, user_id) [pk] }
}
Table invite_codes {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  created_by uuid [ref: > users.id]
}
Table bills {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  created_by uuid [ref: > users.id]
}
Table bill_participants {
  bill_id uuid [ref: > bills.id]
  user_id uuid [ref: > users.id]
  indexes { (bill_id, user_id) [pk] }
}
Table bill_comments {
  id uuid [pk]
  bill_id uuid [ref: > bills.id]
  user_id uuid [ref: > users.id]
}
Table bill_settlements {
  id uuid [pk]
  bill_id uuid [unique, ref: > bills.id]
  initiated_by uuid [ref: > users.id]
}
Table qr_codes {
  id uuid [pk]
  user_id uuid [ref: > users.id]
}
Table payments {
  id uuid [pk]
  bill_id uuid [ref: > bills.id]
  user_id uuid [ref: > users.id]
  qr_code_id uuid [ref: > qr_codes.id]
}
Table payment_transfers {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  bill_id uuid [ref: > bills.id]
  from_user_id uuid [ref: > users.id]
  to_user_id uuid [ref: > users.id]
}
Table expense_categories {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  created_by uuid [ref: > users.id]
}
Table expenses {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  created_by uuid [ref: > users.id]
}
Table expense_splits {
  expense_id uuid [ref: > expenses.id]
  user_id uuid [ref: > users.id]
  indexes { (expense_id, user_id) [pk] }
}
Table expense_receipts {
  id uuid [pk]
  expense_id uuid [ref: > expenses.id]
}
Table notifications {
  id uuid [pk]
  user_id uuid [ref: > users.id]
}
Table disputes {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  creator_id uuid [ref: > users.id]
  handler_id uuid [ref: > users.id]
}
Table dispute_participants {
  dispute_id uuid [ref: > disputes.id]
  user_id uuid [ref: > users.id]
  indexes { (dispute_id, user_id) [pk] }
}
Table dispute_evidence {
  id uuid [pk]
  dispute_id uuid [ref: > disputes.id]
}
Table dispute_resolutions {
  id uuid [pk]
  dispute_id uuid [unique, ref: > disputes.id]
}
Table reviews {
  id uuid [pk]
  room_id uuid [ref: > rooms.id]
  user_id uuid [ref: > users.id]
}
Table review_images {
  id uuid [pk]
  review_id uuid [ref: > reviews.id]
}
```

## 7. 索引与查询建议（关系维度）

- 外键列一律建索引，典型连接列优先建立复合索引：
  - `bills(room_id, status)`，`payments(bill_id, status)`，`expense_splits(expense_id)`
  - `room_members(room_id)`，`room_members(user_id)`，`notifications(user_id, is_read, created_at DESC)`
- 部分索引：未读通知 `WHERE is_read = FALSE`
- Keyset Pagination：使用 `(created_at, id)` 作为翻页游标以避免 OFFSET 慢查询

## 8. 一致性与并发控制

- 事务与行级锁：结算与支付确认使用 `SELECT ... FOR UPDATE` 锁定 `bills`/`bill_settlements`/`payments` 目标行
- 乐观锁（可选）：关键表增加 `version INT NOT NULL DEFAULT 1`，更新带上期望版本，避免覆盖
- 延迟校验：`qr_codes(user_id, qr_type, is_default)` 使用 DEFERRABLE UNIQUE，事务提交时校验

## 9. 功能覆盖校验

- 前端房间、账单、支出、支付、邀请码、通知、争议、评价、收款码、用户设置等页面与 API 均已在上文外键与关系中映射，支持高效的 CRUD 与复杂统计查询。

（本文件与《数据库设计文档》配套，作为外键与关系策略的执行细则与审计依据。）
