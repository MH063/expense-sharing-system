# 统一数据库设计文档

## 1. 设计概述

本文档描述了记账系统的统一数据库设计，整合了前端和管理端的数据库表结构，遵循共享数据库模式设计原则，确保数据一致性、可扩展性和性能优化。

### 1.1 设计原则

1. **统一性**：前端和管理端共享同一数据库，避免数据冗余和不一致
2. **规范化**：遵循数据库规范化原则，减少数据冗余
3. **可扩展性**：设计支持未来功能扩展
4. **性能优化**：合理设计索引和查询结构
5. **安全性**：实现细粒度权限控制
6. **审计追踪**：记录关键数据变更历史

### 1.2 核心模块

1. **用户认证与权限管理**：统一用户认证系统，支持RBAC权限模型
2. **房间管理**：支持多人协作的房间系统
3. **账单管理**：账单创建、分摊和结算
4. **费用管理**：费用记录、审核和统计
5. **支付管理**：支付记录和二维码管理
6. **争议管理**：争议处理和解决
7. **系统管理**：系统配置、日志和审计

## 2. 数据库架构

### 2.1 表结构分类

#### 2.1.1 用户认证与权限管理
- `users` - 用户基础信息
- `user_profiles` - 用户配置文件
- `user_settings` - 用户设置
- `admins` - 管理员信息
- `roles` - 角色定义
- `permissions` - 权限定义
- `role_permissions` - 角色权限关联
- `user_roles` - 用户角色关联
- `admin_roles` - 管理员角色关联
- `user_tokens` - 用户令牌
- `admin_tokens` - 管理员令牌
- `third_party_accounts` - 第三方账户关联

#### 2.1.2 房间管理
- `rooms` - 房间信息
- `room_members` - 房间成员
- `room_invitations` - 房间邀请
- `room_leaders` - 房间负责人
- `room_expense_settings` - 房间费用设置

#### 2.1.3 账单管理
- `bill_categories` - 账单类别
- `bills` - 账单信息
- `bill_comments` - 账单评论
- `bill_splits` - 账单分摊
- `bill_settlement_status` - 账单结算状态
- `bill_statistics` - 账单统计

#### 2.1.4 费用管理
- `expense_categories` - 费用类别
- `expenses` - 费用信息
- `expense_splits` - 费用分摊
- `expense_receipts` - 费用凭证
- `expense_approval_status` - 费用审核状态
- `expense_limits` - 费用限制
- `historical_expense_stats` - 历史费用统计
- `historical_reading_stats` - 历史读数统计
- `expense_dispute_status` - 费用争议状态
- `expense_statistics` - 费用统计
- `expense_tags` - 费用标签
- `expense_tag_relations` - 费用标签关联

#### 2.1.5 支付管理
- `payments` - 支付记录
- `payment_transfers` - 支付转账
- `qr_codes` - 二维码管理
- `qr_payment_records` - 支付码扫描记录
- `user_payment_preferences` - 用户支付偏好

#### 2.1.6 争议管理
- `disputes` - 争议信息
- `dispute_participants` - 争议参与者
- `dispute_evidence` - 争议证据
- `dispute_assignments` - 争议分配
- `dispute_handling_logs` - 争议处理日志

#### 2.1.7 评论管理
- `reviews` - 评论信息
- `review_images` - 评论图片

#### 2.1.8 邀请码管理
- `invite_codes` - 邀请码
- `invite_code_usage` - 邀请码使用记录

#### 2.1.9 活动管理
- `activities` - 活动信息
- `activity_participants` - 活动参与者

#### 2.1.10 特殊支付规则
- `expense_types` - 费用类型
- `special_payment_rules` - 特殊支付规则
- `room_payment_rules` - 房间支付规则

#### 2.1.11 系统管理
- `system_configs` - 系统配置
- `feature_flags` - 功能开关
- `maintenance_windows` - 维护窗口
- `announcements` - 公告

#### 2.1.12 日志和审计
- `user_activity_logs` - 用户活动日志
- `user_status_logs` - 用户状态变更日志
- `admin_operation_logs` - 管理员操作日志
- `data_change_audits` - 数据变更审计
- `system_error_logs` - 系统错误日志
- `system_audit_logs` - 系统审计日志

#### 2.1.13 通知管理
- `notifications` - 通知
- `bill_payment_reminders` - 账单支付提醒

#### 2.1.14 批量任务与报表
- `batch_jobs` - 批量任务
- `report_definitions` - 报表定义
- `report_snapshots` - 报表快照
- `export_tasks` - 导出任务

#### 2.1.15 内容审核与工单
- `moderation_queue` - 审核队列
- `support_tickets` - 支持工单
- `ticket_comments` - 工单评论

#### 2.1.16 集成与回调
- `webhooks` - Webhooks
- `webhook_events` - Webhook事件

#### 2.1.17 文档管理
- `documents` - 文档
- `document_histories` - 文档历史
- `document_types` - 文档类型
- `document_statistics` - 文档统计
- `document_access_logs` - 文档访问日志

#### 2.1.18 系统维护
- `data_backup_records` - 数据备份记录
- `data_restore_records` - 数据恢复记录
- `system_maintenance_plans` - 系统维护计划
- `system_maintenance_executions` - 系统维护执行记录

#### 2.1.19 其他辅助表
- `password_reset_tokens` - 密码重置令牌
- `user_activity_statistics` - 用户活动统计
- `expense_split_history` - 费用分摊历史
- `expense_lines` - 费用线路
- `expense_reviews` - 费用审核
- `abnormal_expenses` - 异常费用
- `abnormal_expense_stats` - 异常费用统计
- `admin_sessions` - 管理员会话
- `admin_permission_history` - 管理员权限变更历史
- `admin_operation_restrictions` - 管理员操作限制
- `admin_operation_statistics` - 管理员操作统计
- `system_performance_metrics` - 系统性能监控
- `system_resource_usage` - 系统资源使用

### 2.2 关键表关系

#### 2.2.1 用户认证与权限管理关系

```
users (1) -> (n) user_profiles
users (1) -> (n) user_settings
users (1) -> (n) user_tokens
users (1) -> (n) user_roles
users (1) -> (n) third_party_accounts

admins (1) -> (1) users
admins (1) -> (n) admin_tokens
admins (1) -> (n) admin_roles

roles (1) -> (n) role_permissions
roles (1) -> (n) user_roles
roles (1) -> (n) admin_roles

permissions (1) -> (n) role_permissions
```

#### 2.2.2 房间管理关系

```
users (1) -> (n) rooms (creator)
users (1) -> (n) room_members
users (1) -> (n) room_invitations (inviter)
users (1) -> (n) room_leaders

rooms (1) -> (n) room_members
rooms (1) -> (n) room_invitations
rooms (1) -> (n) room_leaders
rooms (1) -> (1) room_expense_settings
```

#### 2.2.3 账单管理关系

```
users (1) -> (n) bills (creator)
users (1) -> (n) bill_comments
users (1) -> (n) bill_splits

rooms (1) -> (n) bills
bill_categories (1) -> (n) bills

bills (1) -> (n) bill_comments
bills (1) -> (n) bill_splits
bills (1) -> (1) bill_settlement_status
bills (1) -> (n) bill_statistics
```

#### 2.2.4 费用管理关系

```
users (1) -> (n) expenses (payer)
users (1) -> (n) expense_splits

rooms (1) -> (n) expenses
expense_categories (1) -> (n) expenses

expenses (1) -> (n) expense_splits
expenses (1) -> (n) expense_receipts
expenses (1) -> (1) expense_approval_status
expenses (1) -> (n) expense_lines
expenses (1) -> (1) expense_dispute_status
expenses (1) -> (n) expense_reviews
expenses (1) -> (1) abnormal_expenses
```

## 3. 设计特点

### 3.1 统一用户认证系统

通过将管理员表与用户表关联，实现了统一的用户认证系统。管理员账户基于用户账户创建，但拥有额外的管理权限和功能。

### 3.2 RBAC权限模型

采用基于角色的访问控制(RBAC)模型，通过角色和权限的灵活组合，实现细粒度的权限控制。支持用户角色和管理员角色分离。

### 3.3 版本控制

关键业务表(如bills、expenses等)添加了version字段，支持乐观锁和版本控制，确保并发操作的数据一致性。

### 3.4 审计追踪

通过data_change_audits表记录关键数据变更，支持审计追踪。管理员操作通过admin_operation_logs表记录，确保操作可追溯。

### 3.5 性能优化

1. 合理设计索引，提高查询性能
2. 使用JSONB字段存储灵活配置，减少表结构变更
3. 通过视图简化复杂查询
4. 统计表预计算常用统计数据

### 3.6 可扩展性

1. 模块化设计，便于功能扩展
2. 使用feature_flags控制功能开关
3. 系统配置表支持动态配置
4. 预留扩展字段和表

## 4. 数据一致性保障

### 4.1 外键约束

通过外键约束确保数据引用完整性，如：
- 用户删除时级联删除相关记录
- 房间删除时级联删除相关记录
- 账单删除时级联删除相关记录

### 4.2 事务处理

关键业务操作使用事务确保数据一致性，如：
- 账单创建和分摊记录
- 费用创建和分摊记录
- 支付确认和状态更新

### 4.3 数据校验

通过数据库约束和应用层校验确保数据有效性，如：
- 金额字段非负校验
- 日期字段范围校验
- 状态字段枚举值校验

## 5. 安全性考虑

### 5.1 密码安全

- 密码使用哈希存储
- 支持密码重置功能
- 密码复杂度要求

### 5.2 会话管理

- 使用令牌管理会话
- 令牌过期机制
- 设备管理

### 5.3 权限控制

- 基于角色的权限控制
- 细粒度权限定义
- 权限变更审计

### 5.4 数据保护

- 敏感数据加密
- 数据访问控制
- 操作日志记录

## 6. 部署和维护

### 6.1 数据库初始化

1. 执行统一数据库设计脚本创建表结构
2. 执行初始数据脚本插入基础数据
3. 创建必要的索引和约束
4. 配置数据库参数

### 6.2 数据备份

1. 定期全量备份
2. 增量备份策略
3. 备份验证机制
4. 灾难恢复计划

### 6.3 性能监控

1. 慢查询监控
2. 索引使用情况分析
3. 表空间监控
4. 连接数监控

### 6.4 数据维护

1. 定期数据清理
2. 统计数据更新
3. 索引优化
4. 表分析

## 7. 未来扩展计划

### 7.1 功能扩展

1. 多租户支持
2. 国际化支持
3. 高级报表功能
4. 机器学习集成

### 7.2 性能优化

1. 读写分离
2. 分库分表
3. 缓存策略
4. 查询优化

### 7.3 安全增强

1. 多因素认证
2. 数据脱敏
3. 访问控制增强
4. 安全审计增强

## 8. 总结

本统一数据库设计整合了前端和管理端的数据库表结构，遵循共享数据库模式设计原则，实现了数据一致性、可扩展性和性能优化的平衡。通过合理的表结构设计、索引优化和约束定义，为记账系统提供了稳定可靠的数据存储基础。

设计充分考虑了系统的可维护性和可扩展性，通过模块化设计和标准化接口，支持未来功能的快速迭代和扩展。同时，通过完善的审计日志和权限控制机制，确保了系统的安全性和合规性。