# 记账系统文档中心

## 项目概述

这是一个基于Vue 3 + Node.js的寝室记账系统，支持费用管理、账单生成、智能分摊、扫码支付等功能。

## 文档一致性更新状态

**更新时间：** 2025-11-02  
**更新状态：** ✅ 已完成

### 文档一致性检查与更新

已完成对所有文档的一致性和逻辑性检查，主要更新内容包括：

1. **技术栈统一**：将所有文档中的MySQL统一更新为PostgreSQL（已完成迁移）
2. **开发进度同步**：更新开发计划，反映实际完成的功能
3. **架构状态更新**：技术架构文档反映当前实际架构状态
4. **功能状态同步**：支付码功能开发状态更新为已完成

## 项目结构

本项目按照功能模块划分为以下目录：

- `Admin panel/` - 管理面板相关文档
- `Client application/` - 客户端应用程序
- `Server-side/` - 服务器端代码和配置

## WebSocket实时通信

本项目集成了WebSocket技术，用于实现实时通知和数据同步功能。

### WebSocket功能

1. **实时通知**: 当费用记录、账单、支付等数据发生变化时，实时通知相关用户
2. **事件订阅**: 客户端可以订阅特定类型的事件，只接收感兴趣的通知
3. **连接管理**: 自动重连机制，确保连接的稳定性
4. **错误处理**: 完善的错误处理和日志记录

### WebSocket事件类型

- `expense_created` - 费用记录创建
- `expense_updated` - 费用记录更新
- `bill_created` - 账单创建
- `payment_created` - 支付记录创建
- `review_status_updated` - 审核状态更新
- `dispute_processed` - 争议处理
- `notification` - 通用通知

### 客户端使用示例

```javascript
import websocketClient from '@/utils/websocket-client';

// 连接到WebSocket服务器
websocketClient.connect();

// 订阅事件
websocketClient.subscribe(['expenses', 'bills']);

// 监听事件
websocketClient.on('expense_created', (data) => {
  console.log('新费用记录:', data);
});

// 发送消息
websocketClient.send({
  type: 'subscribe',
  events: ['payments']
});
```

## 环境配置说明

本项目支持开发和生产两种环境，通过不同的环境配置文件来区分使用的数据库。

### 端口配置
- **前端应用**: http://localhost:8000
- **后端API**: http://localhost:4000
- **管理端应用**: http://localhost:8100
- **健康检查**: http://localhost:4000/health

### 环境配置文件

1. `Server-side/.env.development` - 开发环境配置（使用测试数据库）
2. `Server-side/.env.production` - 生产环境配置（使用真实数据库）

### 数据库环境分离

根据项目需求，系统采用双数据库架构：

- **开发环境**: 使用测试数据库，仅用于系统开发和测试
  - 包含模拟测试数据
  - 表结构与生产数据库完全一致
  - 开发人员可以自由操作，不会影响真实用户数据

- **生产环境**: 使用真实用户数据库，用于部署后处理真实业务数据
  - 包含实际用户数据
  - 实施严格的安全防护措施
  - 系统管理员严格禁止接触任何真实业务数据

### 环境切换方式

```bash
# 进入服务器端目录
cd Server-side

# 开发环境
NODE_ENV=development npm start

# 生产环境
NODE_ENV=production npm start

# 开发环境（使用nodemon自动重启）
npm run dev
```

### 配置说明

#### 开发环境配置
- **数据库**: PostgreSQL 13.0+ (测试数据库)
- **数据库名称**: `test_expense_system`
- **用途**: 开发和测试阶段使用
- **数据特点**: 包含模拟测试数据，可随意操作

#### 生产环境配置
- **数据库**: PostgreSQL 13.0+ (生产数据库)
- **数据库名称**: `prod_expense_system`
- **用途**: 部署后处理真实用户数据
- **数据特点**: 包含实际业务数据，需要严格保护

### 数据库初始化

项目提供了数据库初始化脚本：

```bash
# 进入服务器端目录
cd Server-side

# 初始化测试数据库
npm run init:testdb

# 初始化生产数据库
npm run init:proddb
```

## 技术栈

- **前端**: Vue 3.3.4 + Composition API + Element Plus 2.3.8 + Vite
- **后端**: Node.js + Express + PostgreSQL + Redis
- **数据库**: PostgreSQL 13.0+ (主数据库), Redis 6.0+ (缓存数据库)
- **实时通信**: WebSocket
- **构建工具**: Vite + ESLint + Prettier
- **部署平台**: Zeabur

## 功能特性

1. **用户管理**: 多角色权限控制，支持寝室长、缴费人、普通用户等角色
2. **寝室管理**: 寝室创建、成员管理、邀请码机制
3. **费用管理**: 费用录入、智能分摊、多维度统计
4. **账单管理**: 账单生成、支付确认、状态跟踪
5. **支付码功能**: 收款码上传、扫码支付、支付状态流转 ✅ 已实现
6. **审核争议**: 多级审核机制、争议处理流程
7. **统计分析**: 费用趋势分析、支付统计、用户行为分析

## 开发进度

### 已完成 ✅
- 项目基础架构搭建（Vue 3 + Composition API）
- 数据库设计完成（PostgreSQL迁移完成）
- API接口设计完成
- 前端组件框架搭建
- 支付码功能开发完成
- WebSocket实时通信功能

### 进行中 ⏳
- 智能分摊算法优化
- 高级统计分析功能

### 待开发 📋
- 系统集成测试
- 生产环境部署

### 系统角色与数据访问权限

根据项目规范，系统设置了严格的权限控制：

1. **系统管理员**:
   - 仅具备系统维护相关权限
   - 严格禁止接触任何真实业务数据和用户个人信息
   - 只能访问经过脱敏处理的统计数据和系统管理信息

2. **其他角色** (管理员、寝室长、缴费人、普通用户):
   - 根据角色分配相应的业务数据访问权限
   - 在生产环境中访问真实业务数据
   - 在开发环境中访问测试数据

### 注意事项

1. 确保在不同环境中使用对应的数据库配置
2. 开发过程中不应访问生产数据库
3. 生产环境中系统管理员角色严格禁止接触任何真实业务数据
4. 两个数据库的表结构必须保持完全一致
5. 定期备份生产数据库，确保数据安全
6. 在开发环境中测试所有功能后再部署到生产环境