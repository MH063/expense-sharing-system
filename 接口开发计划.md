# 接口开发计划

## 背景

最新代码中已经实现了大量后端接口模块，涵盖认证、用户、寝室、账单、支付、通知、统计等主要领域，但存在以下共性问题：

1. 多个路由文件为了排查问题临时禁用了 `authenticateToken`、`checkRole`、`checkPermission` 等安全中间件，导致实际接口缺乏身份与权限校验。
2. 大量模块已提供核心 CRUD 能力，但与《记账系统API接口设计文档》在路径命名、参数结构、响应格式、状态流转等方面存在差异，影响前后端对齐。
3. 管理后台、争议处理、评价系统、文件管理、系统配置等高级模块仍未落地，接口覆盖度不完整。
4. 控制器内部缺乏一致的错误处理与标准化响应封装，接口监控、审计与测试体系尚未建立。

为保障接口可用性并补齐缺失能力，需要以“现状评估—差距弥补—能力拓展”的节奏推进迭代。

## 当前接口实现现状

| 模块 | 主要路由 | 当前状态 | 重点差距 |
| --- | --- | --- | --- |
| 认证与用户 (`auth-routes.js`、`user-routes.js`) | 登录、注册、忘记/重置密码、刷新 Token、个人资料、密码修改、用户设置、角色分配 | 功能较完整，但部分输入校验与响应格式未统一；用户设置路由已实现但未启用鉴权 | 恢复鉴权链路，校正接口命名/响应结构，补充角色与权限同步逻辑 |
| 管理员认证 (`admin-auth-routes.js`) | `/api/admin/auth/login` | 已实现管理员登录 | 缺少管理员权限接口及操作审计 |
| 寝室与邀请码 (`room-routes.js`、`invite-code-routes.js`) | 寝室 CRUD、成员管理、所有权转移、邀请码生成/验证/使用/撤销 | 功能覆盖较广 | 需对齐接口路径命名、统一返回字段，补充邀请码使用日志 |
| 账单 (`bill-routes.js`) | 账单 CRUD、收据上传、审核、支付确认、分摊重算、结算记录、统计 | 已实现主要流程 | 缺少账单评论、分享等高级接口；响应格式需与文档一致 |
| 支出与费用类型 (`expense-routes.js`、`expense-type-routes.js`) | 支出 CRUD、分摊确认、智能分摊、收款码、支付状态、费用类型管理 | 功能齐备 | 需增加凭证上传、类型标签等扩展字段；完善限流与权限控制 |
| 支付与转账 (`payment-routes.js`、`payment-transfer-routes.js`、`payment-optimization-routes.js`) | 账单支付、离线支付同步、支付转移、支付提醒、支付记录、定时任务 | 功能覆盖较全 | 路由命名与文档不完全一致；缺少支付网关集成与状态机校验 |
| 特殊支付规则 (`special-payment-routes.js`) | 房间规则、规则应用、账单规则查询、支付转移 | 基础能力已具备 | 权限校验暂未启用；规则状态管理需与前端约定 |
| 通知与通知设置 (`notification-routes.js`、`notification-settings-routes.js`) | 通知查询、未读数、标记已读、创建通知、通知设置 CRUD | 通知模块正常，通知设置模块鉴权被禁用且使用占位用户 | 恢复鉴权、补充通知偏好字段校验、与 `user_settings` 表联动 |
| 用户偏好 (`user-preferences-routes.js`) | 偏好查询、更新、删除 | 基础功能存在但使用临时用户 ID | 需恢复鉴权、完善分类与键校验 |
| 统计 (`stats-routes.js`) | 用户、寝室、系统统计、费用预测 | 已提供主要统计接口 | 统计结果需与文档指标对齐；补充趋势、成员对比等端点 |
| 异常支出 (`abnormal-expense-routes.js`) | 异常检测、列表、统计、状态更新 | 管理端能力已初步具备 | 需要补充规则管理、告警推送与前端展示接口 |
| MFA (`mfa-routes.js`) | MFA 状态、生成密钥、校验、禁用 | 功能可用 | 需与登录流程整合、梳理错误码 |
| 收款码 (`qr-code-routes.js`) | 上传、列表、状态切换、默认码、删除 | 功能完整 | 需迁移到统一文件存储方案并补充鉴权 |
| 缺失模块 | 争议、评价、文件、系统配置、WebSocket 事件、管理员全量功能等 | 未实现 | 需要新建路由、控制器与数据库结构 |

## 主要差距

1. 安全链路未闭合：多个路由文件因排查问题而注释掉鉴权中间件，存在高风险，需要在修复后第一时间恢复。
2. 接口标准不统一：参数校验、错误码、分页结构、日期与金额格式缺乏统一规范，需要在现有实现上进行集中整改。
3. 高级模块缺口：争议处理、评价体系、文件管理、系统配置、管理员操作审计等核心模块尚未实现。
4. 数据一致性问题：部分控制器直接操作数据库，缺少事务与错误回滚；某些模块未与最新的表结构对齐。
5. 文档与实现脱节：现有接口实现与参考文档差异较大，缺少自动化校验与同步流程。

## 阶段拆分

### 阶段一：基础能力修复
- 状态：已完成（2025-11-05）
  - 恢复并验证所有核心路由的 `authenticateToken`、`checkRole`、`checkPermission` 中间件；`/api/notification-settings` 与 `/api/user-preferences` 已重新挂载鉴权并使用真实用户标识。
  - 统一响应处理流程：在 `server.js` 恢复 `checkRequestBodySize`、`checkTokenLength`、全局速率限制、AI Token 处理，并保持 `standardResponseMiddleware` 标准输出。
  - 审计与安全增强：请求签名与 IP 白名单中间件限定在 `/api/` 路由生效，避免误拦截静态资源；保留 `httpLogger` 与全局错误处理，便于追踪审计。
- 下一步：针对阶段一改动新增冒烟测试与文档化的鉴权矩阵，纳入后续 CI。

### 阶段二：现有模块对齐
- 按模块对照 API 设计文档，修正路由命名、HTTP 方法、参数/响应结构。
- 对用户、寝室、账单、支出、支付、通知、统计等现有模块进行字段校验与业务流程补强。
- 编写模块级单元测试与集成测试，覆盖成功与失败场景。

### 阶段三：结算与支付增强
- 已完成：
  - 支付确认加入幂等性（请求头 `Idempotency-Key` 与 `transaction_id` 双重去重）。
  - 离线支付新增“标记同步失败”与“重试同步”端点：
    - `PATCH /api/payment-optimization/offline-payments/:paymentId/failed`
    - `POST /api/payment-optimization/offline-payments/:paymentId/retry`
  - 保持原支付查询/提醒端点工作，均需认证。
- 待办：
  - 支付状态机细化（pending→confirmed/canceled/failed）与外部网关对接（占位）。
  - 收款码与支付转移的权限、限流与幂等性完善。
- 新增端点：
  - 账单评论：`POST /api/bills/:id/comments`、`GET /api/bills/:id/comments`
  - 账单分享：`POST /api/bills/:id/share`、`GET /api/bills/share/:code`
- 验收标准：
  - 重复支付请求在 5 分钟窗口内被视为幂等，返回同一记录；
  - 离线支付失败标记与重试可观察到状态从 `pending→failed→pending` 的正确变更；
  - 文档与端点索引同步更新，并保留回滚策略。

### 阶段四：个性化与通知体系
- 状态：已启动（2025-11-05）
  - 已恢复通知设置与用户偏好模块的鉴权，统一使用 `req.user.sub`，服务层对齐共享连接池。
  - 完善通知订阅：支持按类型过滤、未读计数、批量已读（`notificationValidationRules.markAllRead`）。
  - 偏好同步：`user-preferences` 支持按类别分组查询、单项更新与批量更新，值统一存储为 JSON。
  - 文档与管理端索引已同步 `/api/stats/forecast`、通知/偏好端点状态。
- 待办：
  - 与 `user_settings` 表联动（缺省值与开关同步），新增字段校验规则。
  - WebSocket 推送占位：账单到期与支付状态变更事件推送；提供订阅管理端点草案。
  - 为通知与偏好端点补充限流与审计日志。
### 阶段五：缺失模块补充
- 新增争议（`/api/disputes`）、评价（`/api/reviews`）、文件（`/api/files`）、系统配置（`/api/system`）、导出、运维监控等接口。
- 设计并实现 WebSocket 事件分发及订阅管理。
- 补充管理员用户、角色、权限、操作日志、系统公告、任务调度等后台接口。

### 阶段六：文档与自动化
- 建立接口契约测试与文档自动生成流程。
- 更新 `Admin panel/docs/API接口设计文档.md` 与研发手册，使其与实现实时同步。
- 引入 API 版本管理、回归测试、性能基准测试。

## 技术实现要点

1. 中间件恢复：逐一验证并重新启用 `authenticateToken`、`checkRole`、`checkPermission`、限流、防暴力破解、请求签名等安全链路。
2. 数据库一致性：依据现有 SQL 脚本，补充缺失表、索引、约束，必要时引入迁移工具记录演进历史。
3. 模块化控制器：为每个模块提炼服务层，保证事务安全、错误传播与日志记录一致。
4. 标准响应与错误码：制定统一的响应模板与错误码表，在控制器内集中引用。
5. 审计与监控：关键敏感操作写入审计日志，引入指标采集与健康检查。
6. 测试覆盖：以 Jest/Supertest（或现有测试框架）覆盖接口行为、权限校验、数据库交互，包括正向与异常路径。
7. 持续文档同步：开发完成后更新 Markdown 文档，必要时补充 OpenAPI/Swagger 描述并加入 CI 校验。

## 里程碑与交付

- 里程碑 1（基础修复）：完成阶段一任务，所有既有路由鉴权恢复，响应结构统一，通过冒烟测试。
- 里程碑 2（模块对齐）：阶段二完成，核心业务模块（用户/寝室/账单/支出/支付/通知/统计）与设计文档一致，测试通过。
- 里程碑 3（支付增强）：阶段三交付，账单与支付全流程闭环，包含规则、离线支付、支付提醒等高级能力。
- 里程碑 4（个性化与通知体系）：阶段四完成，通知与偏好模块稳定，支持配置化与推送联动。
- 里程碑 5（缺失模块补充）：阶段五落实，争议、评价、文件、系统配置、管理员后台全面上线。
- 里程碑 6（自动化体系）：阶段六完成，文档、契约测试、回归流程打通。

每个里程碑必须满足：
- 通过自动化测试与手动验收
- 所有数据库迁移经评审并上线
- 文档、变更记录同步更新
- 关键接口完成性能基准测试

## 风险与缓解措施

| 风险 | 描述 | 缓解措施 |
| --- | --- | --- |
| 鉴权恢复导致接口不可用 | 临时禁用的中间件恢复后可能暴露历史问题 | 在 Stage 1 建立灰度开关并分模块逐步启用，配合回滚策略 |
| 文档与实现差距扩大 | 迭代过程中未同步更新设计文档 | 将文档更新纳入开发 Definition of Done，并建立自动化校验 |
| 数据结构不一致 | 老数据与新字段、约束不兼容 | 提前梳理数据迁移方案，提供脚本与回退策略 |
| 高级模块设计复杂 | 争议、评价、文件、管理员模块涉及多方流程 | 先输出详细设计评审，再进入开发迭代 |
| 资源不足 | 涉及模块多、范围广 | 明确优先级，按阶段逐步交付，必要时增加人力或外包特定模块 |

## 资源与分工建议

- 后端开发：2-3 人，分别负责基础修复、核心模块对齐、缺失模块开发。
- 数据库工程师：1 人，负责结构迁移、性能优化、数据校验。
- QA/测试工程师：1-2 人，负责接口契约、自动化、性能与安全测试。
- 项目管理：1 人，负责阶段计划、进度跟踪、跨团队协调。

## 下一步

1. 按阶段二任务拆解，与前端团队对齐接口字段和响应格式变更。
2. 基于阶段一成果整理鉴权矩阵与监控报警配置，纳入运行手册。
3. 搭建接口测试基线（冒烟 + 契约），作为后续迭代准入门槛。
4. 输出缺失模块的详细设计文档（数据库、接口、流程、权限），进入阶段五开发准备。
