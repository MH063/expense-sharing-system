# 数据库外键约束与表关系设计（用户端/管理端·PostgreSQL 18）

本文件系统化描述用户端与管理端数据库的外键策略、关系类型、一致性保障与联级操作设计，并提供可执行的核心表 SQL 片段与 ER 关系示意，严格遵循 PostgreSQL 18 语法规范。

## 1. 关系模型总览

- 用户端：
  - 用户与房间：N-M，通过 `room_members`；房间与账单/支出/通知/争议/评价/特殊规则：1-N
  - 账单与用户：N-M，通过 `bill_participants`；账单与评论：1-N；账单与结算：1-1
  - 支付：`payments` 关联账单和用户；`payment_transfers` 记录成员之间转账
  - 支出：`expenses` 与用户 N-M（`expense_splits`），与凭证 1-N
  - 争议：`disputes` 与用户 N-M（`dispute_participants`），与证据 1-N，与解决方案 1-1
  - 收款码：`qr_codes` 归属用户，payments 可引用
- 管理端：
  - RBAC：`admin_users` ↔ `roles`（N-M，经 `admin_user_roles`）；`roles` ↔ `permissions`（N-M，经 `role_permissions`）
  - 审计：`admin_operation_logs`、`data_change_audits` 关联 `admin_users`
  - 批量/报表：`batch_jobs`、`batch_job_runs`、`report_definitions`、`report_snapshots`、`data_exports` 与 `admin_users` 的外键关联
  - 审核/工单：`moderation_queue`（关联用户端实体）、`moderation_actions`（关联队列与 `admin_users`）、`tickets`（关联 `users` 与 `admin_users`）、`ticket_comments`
  - 配置/维护：`feature_flags`（独立）、`maintenance_windows`、`admin_announcements` 关联 `admin_users`
  - 集成回调：`webhooks` 与 `webhook_events`

## 2. 外键与级联策略清单（新增管理端部分）

说明：与用户端相同，ON UPDATE 统一 CASCADE；ON DELETE 依据业务场景选择。

```sql
-- RBAC
ALTER TABLE role_permissions
  ADD CONSTRAINT fk_role_permissions_role
  FOREIGN KEY (role_id) REFERENCES roles(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE role_permissions
  ADD CONSTRAINT fk_role_permissions_permission
  FOREIGN KEY (permission_id) REFERENCES permissions(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE role_permissions
  ADD CONSTRAINT fk_role_permissions_admin
  FOREIGN KEY (granted_by) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE admin_user_roles
  ADD CONSTRAINT fk_admin_user_roles_admin
  FOREIGN KEY (admin_user_id) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE admin_user_roles
  ADD CONSTRAINT fk_admin_user_roles_role
  FOREIGN KEY (role_id) REFERENCES roles(id)
  ON UPDATE CASCADE ON DELETE CASCADE;

-- 审计
ALTER TABLE admin_operation_logs
  ADD CONSTRAINT fk_admin_operation_logs_user
  FOREIGN KEY (admin_user_id) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE data_change_audits
  ADD CONSTRAINT fk_data_change_audits_user
  FOREIGN KEY (admin_user_id) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

-- 批量/报表
ALTER TABLE batch_jobs
  ADD CONSTRAINT fk_batch_jobs_user
  FOREIGN KEY (queued_by) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE batch_job_runs
  ADD CONSTRAINT fk_batch_job_runs_job
  FOREIGN KEY (job_id) REFERENCES batch_jobs(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE report_definitions
  ADD CONSTRAINT fk_report_definitions_user
  FOREIGN KEY (created_by) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE report_snapshots
  ADD CONSTRAINT fk_report_snapshots_definition
  FOREIGN KEY (report_id) REFERENCES report_definitions(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE data_exports
  ADD CONSTRAINT fk_data_exports_user
  FOREIGN KEY (requested_by) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

-- 审核/工单
ALTER TABLE moderation_actions
  ADD CONSTRAINT fk_moderation_actions_queue
  FOREIGN KEY (queue_id) REFERENCES moderation_queue(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE moderation_actions
  ADD CONSTRAINT fk_moderation_actions_admin
  FOREIGN KEY (admin_user_id) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE tickets
  ADD CONSTRAINT fk_tickets_user
  FOREIGN KEY (created_by) REFERENCES users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE tickets
  ADD CONSTRAINT fk_tickets_admin
  FOREIGN KEY (assigned_admin_id) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

ALTER TABLE ticket_comments
  ADD CONSTRAINT fk_ticket_comments_ticket
  FOREIGN KEY (ticket_id) REFERENCES tickets(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE ticket_comments
  ADD CONSTRAINT fk_ticket_comments_admin
  FOREIGN KEY (admin_user_id) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

-- 配置/维护
ALTER TABLE maintenance_windows
  ADD CONSTRAINT fk_maintenance_windows_admin
  FOREIGN KEY (created_by) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE admin_announcements
  ADD CONSTRAINT fk_admin_announcements_admin
  FOREIGN KEY (created_by) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;

-- Webhook
ALTER TABLE webhooks
  ADD CONSTRAINT fk_webhooks_admin
  FOREIGN KEY (created_by) REFERENCES admin_users(id)
  ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE webhook_events
  ADD CONSTRAINT fk_webhook_events_webhook
  FOREIGN KEY (webhook_id) REFERENCES webhooks(id)
  ON UPDATE CASCADE ON DELETE CASCADE;
```

（用户端的外键清单请参考本文件上一版本章节，未改动。）

## 3. 关联类型与操作规则

- RBAC：
  - `admin_users` ↔ `roles`：N-M，通过 `admin_user_roles`；删除管理员或角色时，关联记录 CASCADE
  - `roles` ↔ `permissions`：N-M，通过 `role_permissions`；删除角色或权限时，关联记录 CASCADE
- 审核/工单：
  - `moderation_queue` ↔ 用户端实体：逻辑关联（entity_table+entity_id），删除实体时应由业务逻辑清理队列
  - `tickets` 与 `users`：1-N；与 `admin_users`：1-N；删除用户或管理员时置空引用
- 报表/任务：
  - `batch_jobs` 1-N `batch_job_runs`
  - `report_definitions` 1-N `report_snapshots`
- Webhook：`webhooks` 1-N `webhook_events`

## 4. ER 关系图增量（仅展示新增管理端）

```
[admin_users] *--* [roles] via [admin_user_roles]
[roles] *--* [permissions] via [role_permissions]
[admin_users] 1--* [admin_operation_logs]
[admin_users] 1--* [data_change_audits]
[batch_jobs] 1--* [batch_job_runs]
[report_definitions] 1--* [report_snapshots]
[webhooks] 1--* [webhook_events]
[tickets] 1--* [ticket_comments]
```

## 5. 索引策略与优化（管理端）

- RBAC：
  - `permissions(code)` UNIQUE；`role_permissions(role_id, permission_id)` PK；`admin_user_roles(admin_user_id, role_id)` PK
- 审计：
  - `admin_operation_logs(admin_user_id, created_at DESC)`；`data_change_audits(table_name, record_id, created_at DESC)`
- 批量/报表：
  - `batch_jobs(job_type, status, created_at DESC)`；`report_snapshots(report_id, generated_at DESC)`；`data_exports(export_type, status, created_at DESC)`
- 工单：
  - `tickets(status, assigned_admin_id, updated_at DESC)`

## 6. 并发与事务（管理端）

- RBAC 授权、撤销在事务内原子完成；必要时在应用层刷新权限缓存
- 审核/工单处理使用行锁串行化同一对象：`SELECT ... FOR UPDATE`
- 批量任务的状态流转通过乐观并发（`WHERE status = ...`）与行锁结合保证唯一运行

## 7. 典型查询示例（管理端）

```sql
-- 管理员的权限清单
SELECT DISTINCT p.code
FROM admin_user_roles aur
JOIN role_permissions rp ON rp.role_id = aur.role_id
JOIN permissions p ON p.id = rp.permission_id
WHERE aur.admin_user_id = $1;

-- 待办审核数量
SELECT status, COUNT(*) FROM moderation_queue GROUP BY status;

-- 各状态工单数量（按管理员）
SELECT assigned_admin_id, status, COUNT(*)
FROM tickets
GROUP BY assigned_admin_id, status;
```

## 8. 版本记录

- v2.0.0：新增管理端外键清单与关系说明（RBAC、审计、批量/报表、审核/工单、配置与 Webhook），不影响用户端外键。
