# æ”¯ä»˜ç æœ¬åœ°å­˜å‚¨æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£

## 1. æ–¹æ¡ˆæ¦‚è¿°

### 1.1 æ–¹æ¡ˆé€‰æ‹©
é€‰æ‹©æ–¹æ¡ˆä¸€ï¼šå°†ç”¨æˆ·ä¸Šä¼ çš„æ”¶æ¬¾ç å›¾ç‰‡ä»…å­˜å‚¨åœ¨ç”¨æˆ·æœ¬åœ°è®¾å¤‡æŒ‡å®šæ–‡ä»¶å¤¹ä¸­ï¼Œä½¿ç”¨æ—¶ä¸´æ—¶è°ƒç”¨ï¼Œä¸ä¸Šä¼ è‡³æœåŠ¡å™¨ã€‚

### 1.2 æ ¸å¿ƒä¼˜åŠ¿
- **å®‰å…¨æ€§é«˜**ï¼šæ”¯ä»˜ä¿¡æ¯ä¸ç»è¿‡æœåŠ¡å™¨ï¼Œé¿å…æ•°æ®æ³„éœ²é£é™©
- **æˆæœ¬ä½**ï¼šæ— éœ€æœåŠ¡å™¨å­˜å‚¨ç©ºé—´ï¼Œé€‚åˆZeaburå…è´¹éƒ¨ç½²
- **å“åº”å¿«**ï¼šæœ¬åœ°è¯»å–é€Ÿåº¦å¿«ï¼Œç”¨æˆ·ä½“éªŒå¥½

## 2. æŠ€æœ¯æ¶æ„è®¾è®¡

### 2.1 å­˜å‚¨ä½ç½®è®¾è®¡
```
ç”¨æˆ·è®¾å¤‡å­˜å‚¨ç»“æ„ï¼š
â”œâ”€â”€ åº”ç”¨æ•°æ®ç›®å½•/
â”‚   â”œâ”€â”€ payment_codes/
â”‚   â”‚   â”œâ”€â”€ user_{userId}/
â”‚   â”‚   â”‚   â”œâ”€â”€ wechat_qr.png
â”‚   â”‚   â”‚   â”œâ”€â”€ alipay_qr.png
â”‚   â”‚   â”‚   â””â”€â”€ metadata.json
â”‚   â”‚   â””â”€â”€ temp/
â”‚   â””â”€â”€ cache/
```

### 2.2 æ–‡ä»¶å‘½åè§„èŒƒ
- å¾®ä¿¡æ”¶æ¬¾ç ï¼š`wechat_qr.png`
- æ”¯ä»˜å®æ”¶æ¬¾ç ï¼š`alipay_qr.png`
- å…ƒæ•°æ®æ–‡ä»¶ï¼š`metadata.json`

### 2.3 å…ƒæ•°æ®ç»“æ„
```json
{
  "userId": "uuid",
  "uploadTime": "2024-01-01T10:00:00Z",
  "lastUsed": "2024-01-01T10:00:00Z",
  "fileSize": 102400,
  "mimeType": "image/png",
  "isActive": true
}
```

## 3. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è®¾è®¡

### 3.1 æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨ (LocalStorageManager)
```javascript
class LocalStorageManager {
  constructor() {
    this.storageBasePath = this.getStoragePath();
    this.maxFileSize = 5 * 1024 * 1024; // 5MB
    this.allowedTypes = ['image/png', 'image/jpeg', 'image/jpg'];
  }
  
  // è·å–å­˜å‚¨è·¯å¾„
  getStoragePath() {
    if (typeof window !== 'undefined') {
      // æµè§ˆå™¨ç¯å¢ƒ
      return 'payment_codes/';
    } else {
      // Node.jsç¯å¢ƒ
      return path.join(process.cwd(), 'user_data', 'payment_codes');
    }
  }
  
  // ä¿å­˜æ”¯ä»˜ç 
  async savePaymentCode(userId, qrType, fileData) {
    const userDir = path.join(this.storageBasePath, `user_${userId}`);
    await this.ensureDirectory(userDir);
    
    const fileName = `${qrType}_qr.png`;
    const filePath = path.join(userDir, fileName);
    
    // éªŒè¯æ–‡ä»¶
    await this.validateFile(fileData);
    
    // ä¿å­˜æ–‡ä»¶
    await this.writeFile(filePath, fileData);
    
    // æ›´æ–°å…ƒæ•°æ®
    await this.updateMetadata(userId, qrType, fileData);
    
    return filePath;
  }
  
  // è¯»å–æ”¯ä»˜ç 
  async getPaymentCode(userId, qrType) {
    const filePath = path.join(this.storageBasePath, `user_${userId}`, `${qrType}_qr.png`);
    
    if (await this.fileExists(filePath)) {
      const fileData = await this.readFile(filePath);
      await this.updateLastUsed(userId, qrType);
      return fileData;
    }
    
    return null;
  }
}
```

### 3.2 æ”¯ä»˜ç éªŒè¯å™¨ (PaymentCodeValidator)
```javascript
class PaymentCodeValidator {
  constructor() {
    this.validTypes = ['wechat', 'alipay'];
  }
  
  // éªŒè¯æ”¯ä»˜ç ç±»å‹
  validateType(qrType) {
    if (!this.validTypes.includes(qrType)) {
      throw new Error(`ä¸æ”¯æŒçš„æ”¯ä»˜ç ç±»å‹: ${qrType}`);
    }
    return true;
  }
  
  // éªŒè¯å›¾ç‰‡æ ¼å¼
  async validateImageFormat(fileData) {
    // æ£€æŸ¥æ–‡ä»¶å¤´ä¿¡æ¯
    const header = fileData.slice(0, 8);
    const isPNG = header[0] === 0x89 && header.toString('ascii', 1, 4) === 'PNG';
    const isJPEG = header[0] === 0xFF && header[1] === 0xD8;
    
    if (!isPNG && !isJPEG) {
      throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼ PNGæˆ–JPEGæ ¼å¼çš„å›¾ç‰‡');
    }
    
    return true;
  }
  
  // éªŒè¯å›¾ç‰‡å†…å®¹æ˜¯å¦ä¸ºæœ‰æ•ˆæ”¯ä»˜ç 
  async validateQRContent(imageData) {
    // ä½¿ç”¨å›¾åƒå¤„ç†åº“éªŒè¯äºŒç»´ç å†…å®¹
    try {
      const qrContent = await this.decodeQRCode(imageData);
      return this.isValidPaymentURL(qrContent);
    } catch (error) {
      throw new Error('æ— æ³•è¯†åˆ«æœ‰æ•ˆçš„æ”¯ä»˜äºŒç»´ç ');
    }
  }
  
  // è§£ç äºŒç»´ç 
  async decodeQRCode(imageData) {
    // ä½¿ç”¨äºŒç»´ç è§£ç åº“
    // è¿”å›è§£ç åçš„URLæˆ–æ–‡æœ¬å†…å®¹
  }
  
  // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆæ”¯ä»˜URL
  isValidPaymentURL(url) {
    const wechatPattern = /^weixin:\/\/.*/;
    const alipayPattern = /^alipays?:\/\/.*/;
    
    return wechatPattern.test(url) || alipayPattern.test(url);
  }
}
```

### 3.3 æ”¯ä»˜æµç¨‹ç®¡ç†å™¨ (PaymentFlowManager)
```javascript
class PaymentFlowManager {
  constructor() {
    this.storageManager = new LocalStorageManager();
    this.validator = new PaymentCodeValidator();
  }
  
  // æ”¯ä»˜ç¡®è®¤æµç¨‹
  async confirmPayment(userId, billId, amount, payerId) {
    // 1. è·å–æ”¶æ¬¾äººä¿¡æ¯
    const payee = await this.getPayeeInfo(billId);
    
    // 2. è·å–æ”¶æ¬¾ç 
    const qrCode = await this.storageManager.getPaymentCode(payee.userId, 'wechat');
    
    if (!qrCode) {
      throw new Error('æ”¶æ¬¾äººæœªè®¾ç½®æ”¶æ¬¾ç ');
    }
    
    // 3. ç”Ÿæˆæ”¯ä»˜ç¡®è®¤è®°å½•
    const paymentRecord = await this.createPaymentRecord({
      userId: payerId,
      payeeId: payee.userId,
      billId: billId,
      amount: amount,
      status: 'pending'
    });
    
    return {
      paymentId: paymentRecord.id,
      payeeName: payee.name,
      amount: amount,
      qrCode: qrCode,
      timestamp: new Date().toISOString()
    };
  }
  
  // æ”¯ä»˜å®Œæˆç¡®è®¤
  async completePayment(paymentId) {
    // æ›´æ–°æ”¯ä»˜çŠ¶æ€
    await this.updatePaymentStatus(paymentId, 'completed');
    
    // å‘é€é€šçŸ¥
    await this.sendPaymentNotification(paymentId);
    
    // æ›´æ–°è´¦å•çŠ¶æ€
    await this.updateBillStatus(paymentId);
  }
}
```

## 4. å‰ç«¯ç»„ä»¶è®¾è®¡

### 4.1 æ”¯ä»˜ç ä¸Šä¼ ç»„ä»¶ (QRCodeUploader.vue)
```vue
<template>
  <div class="qr-uploader">
    <div class="upload-area" @click="triggerUpload">
      <input 
        ref="fileInput" 
        type="file" 
        accept="image/*" 
        @change="handleFileSelect" 
        style="display: none"
      >
      <div v-if="!currentImage" class="upload-placeholder">
        <i class="upload-icon">ğŸ“·</i>
        <p>ç‚¹å‡»ä¸Šä¼ {{ qrType === 'wechat' ? 'å¾®ä¿¡' : 'æ”¯ä»˜å®' }}æ”¶æ¬¾ç </p>
      </div>
      <div v-else class="image-preview">
        <img :src="currentImage" :alt="qrType + 'æ”¶æ¬¾ç '">
        <button @click.stop="removeImage" class="remove-btn">åˆ é™¤</button>
      </div>
    </div>
    
    <div v-if="error" class="error-message">{{ error }}</div>
    
    <div class="upload-info">
      <p>æ”¯æŒæ ¼å¼ï¼šPNGã€JPGã€JPEG</p>
      <p>æœ€å¤§æ–‡ä»¶å¤§å°ï¼š5MB</p>
    </div>
  </div>
</template>

<script>
import { LocalStorageManager, PaymentCodeValidator } from '../utils/payment-code-manager';

export default {
  name: 'QRCodeUploader',
  props: {
    qrType: {
      type: String,
      required: true,
      validator: value => ['wechat', 'alipay'].includes(value)
    },
    userId: {
      type: String,
      required: true
    }
  },
  data() {
    return {
      currentImage: null,
      error: null,
      storageManager: null,
      validator: null
    };
  },
  mounted() {
    this.storageManager = new LocalStorageManager();
    this.validator = new PaymentCodeValidator();
    this.loadExistingImage();
  },
  methods: {
    async loadExistingImage() {
      try {
        const imageData = await this.storageManager.getPaymentCode(this.userId, this.qrType);
        if (imageData) {
          this.currentImage = URL.createObjectURL(new Blob([imageData]));
        }
      } catch (error) {
        console.error('åŠ è½½ç°æœ‰å›¾ç‰‡å¤±è´¥:', error);
      }
    },
    
    triggerUpload() {
      this.$refs.fileInput.click();
    },
    
    async handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      this.error = null;
      
      try {
        // éªŒè¯æ–‡ä»¶
        await this.validator.validateImageFormat(await file.arrayBuffer());
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        const fileData = await file.arrayBuffer();
        await this.storageManager.savePaymentCode(this.userId, this.qrType, fileData);
        
        // æ›´æ–°é¢„è§ˆ
        this.currentImage = URL.createObjectURL(file);
        
        this.$emit('upload-success', { type: this.qrType, file: file });
      } catch (error) {
        this.error = error.message;
        this.$emit('upload-error', error);
      }
    },
    
    async removeImage() {
      try {
        await this.storageManager.deletePaymentCode(this.userId, this.qrType);
        this.currentImage = null;
        this.$emit('remove-success', this.qrType);
      } catch (error) {
        this.error = 'åˆ é™¤å¤±è´¥ï¼š' + error.message;
      }
    }
  }
};
</script>
```

### 4.2 æ”¯ä»˜ç¡®è®¤å¼¹çª—ç»„ä»¶ (PaymentConfirmModal.vue)
```vue
<template>
  <div class="payment-modal" v-if="visible">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ç¡®è®¤æ”¯ä»˜</h3>
        <button @click="close" class="close-btn">Ã—</button>
      </div>
      
      <div class="payment-info">
        <div class="payee-info">
          <span class="label">æ”¶æ¬¾äººï¼š</span>
          <span class="value">{{ paymentInfo.payeeName }}</span>
        </div>
        <div class="amount-info">
          <span class="label">æ”¯ä»˜é‡‘é¢ï¼š</span>
          <span class="value amount">Â¥{{ paymentInfo.amount }}</span>
        </div>
      </div>
      
      <div class="qr-code-section">
        <div class="qr-code-container">
          <img :src="paymentInfo.qrCode" alt="æ”¶æ¬¾äºŒç»´ç " class="qr-image">
        </div>
        <p class="qr-tip">è¯·ä½¿ç”¨{{ paymentInfo.qrType === 'wechat' ? 'å¾®ä¿¡' : 'æ”¯ä»˜å®' }}æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</p>
      </div>
      
      <div class="payment-actions">
        <button @click="confirmPayment" class="confirm-btn">æˆ‘å·²æ”¯ä»˜</button>
        <button @click="close" class="cancel-btn">å–æ¶ˆæ”¯ä»˜</button>
      </div>
    </div>
  </div>
</template>
```

## 5. å®‰å…¨è®¾è®¡

### 5.1 æ•°æ®åŠ å¯†
- æœ¬åœ°å­˜å‚¨çš„å…ƒæ•°æ®æ–‡ä»¶ä½¿ç”¨AESåŠ å¯†
- åŠ å¯†å¯†é’¥å­˜å‚¨åœ¨ç”¨æˆ·æœ¬åœ°ï¼Œä¸ä¼ è¾“åˆ°æœåŠ¡å™¨

### 5.2 è®¿é—®æ§åˆ¶
- æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ”¯ä»˜ç ç›®å½•
- æ–‡ä»¶è·¯å¾„åŒ…å«ç”¨æˆ·IDï¼Œé˜²æ­¢è¶Šæƒè®¿é—®

### 5.3 æ¸…ç†æœºåˆ¶
- å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶
- ç”¨æˆ·æ³¨é”€æ—¶åˆ é™¤ç›¸å…³æ”¯ä»˜ç æ•°æ®

## 6. å…¼å®¹æ€§è®¾è®¡

### 6.1 æµè§ˆå™¨å…¼å®¹æ€§
- æ”¯æŒç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Safariã€Edgeï¼‰
- ä½¿ç”¨IndexedDBä½œä¸ºå¤‡é€‰å­˜å‚¨æ–¹æ¡ˆ

### 6.2 ç§»åŠ¨ç«¯é€‚é…
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡
- è§¦æ‘¸å‹å¥½çš„äº¤äº’è®¾è®¡

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 å›¾ç‰‡å‹ç¼©
- ä¸Šä¼ æ—¶è‡ªåŠ¨å‹ç¼©å¤§å›¾ç‰‡
- ä¿æŒäºŒç»´ç å¯è¯†åˆ«æ€§çš„åŒæ—¶å‡å°æ–‡ä»¶å¤§å°

### 7.2 ç¼“å­˜ç­–ç•¥
- å¸¸ç”¨æ”¯ä»˜ç ç¼“å­˜åœ¨å†…å­˜ä¸­
- å‡å°‘æ–‡ä»¶IOæ“ä½œ

è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆå®Œå…¨åŸºäºæœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿æ”¯ä»˜ä¿¡æ¯å®‰å…¨ï¼ŒåŒæ—¶ä¸ç°æœ‰ç³»ç»Ÿæ¶æ„å®Œç¾é›†æˆã€‚